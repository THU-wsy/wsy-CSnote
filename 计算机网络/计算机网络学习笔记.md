
# 第1章 计算机网络和因特网

## 1.1 因特网

### 计算机网络的概念

计算机网络是一个将分散的、具有独立功能的计算机系统，通过通信设备与线路连接起来，由功能完善的软件实现资源共享和信息传递的系统。

网络(network)由若干结点(node)和连接这些结点的链路(link)组成。多个网络还可以通过路由器互连起来，构成一个覆盖范围更大的网络，称为互联网(internet)，这些网络之间的通信协议可以是任意的。

### 因特网的具体构成

因特网(Internet)是世界上最大的互联网。

- 端系统(end system, 也称为主机, host) 通过通信链路(communication link)和分组交换机(packet switch)连接到一起。因特网中最著名的两种分组交换机是路由器(router)和链路层交换机(link-layer switch)，链路层交换机通常用于接入网中，而路由器通常用于网络核心中。
- 当一台端系统要向另一台端系统发送数据时，发送端系统将数据分段，并为每段加上首部字节，由此形成的信息包就称为分组(packet)。
- 端系统通过因特网服务提供商(ISP, Internet Service Provider)接入因特网。每个ISP自身就是一个由多台分组交换机和多段通信链路组成的网络。
- 协议(protocol)定义了在两个或多个通信实体之间交换的报文的格式和顺序，以及报文发送和接收一条报文或其他事件所采取的动作。因特网的主要协议统称为TCP/IP，其中TCP(Transmission Control Protocol, 传输控制协议)和IP(Internet Protocol, 网际协议)是因特网中两个最为重要的协议。
- 因特网标准(Internet standard)由因特网工程任务组(IETF)研发，IETF的标准文档称为请求评论(RFC, Request For Comment)。

## 1.2 网络边缘

### 接入网

端系统位于网络边缘，而接入网是指将端系统物理连接到其边缘路由器的网络(边缘路由器是端系统到任何其他远程端系统的路径上的第一台路由器)。

家庭接入：DSL、电缆、FTTH、拨号和卫星
宽带住宅接入有两种最流行的类型：数字用户线(DSL, Digital Subscriber Line)和电缆。住户通常从提供本地电话接入的本地电话公司处获得DSL因特网接入，所以使用DSL时用户的本地电话公司也是它的ISP，家庭电话线同时承载了数据和传统的电话信号(用不同的频率进行编码)，从而使一个电话呼叫和一个因特网连接能够同时共享DSL链路，这种方法称为频分复用技术；电缆因特网接入则利用了有线电视公司现有的有线电视基础设施，住宅从提供有线电视的公司获得了电缆因特网接入，电缆因特网接入的一个重要特征是共享广播媒体；更高速率的新兴技术是光纤到户(FTTH, Fiber To The Home)，即从本地中心局直接到家庭提供了一条光纤路径；除此之外还有使用传统电话线的拨号接入，以及使用卫星链路接入因特网。

企业(和家庭)接入：以太网和WiFi
在公司和大学校园以及越来越多的家庭环境中，使用局域网LAN将端系统连接到边缘路由器。尽管有许多不同类型的局域网技术，但是以太网到目前为止是公司、大学和家庭网络中最为流行的接入技术，以太网用户使用双绞铜线与一台以太网交换机相连，再与更大的因特网相连。而WiFi是无线LAN接入，无线用户从一个接入点发送分组，该接入点与企业网连接(很可能使用了有线以太网)，企业网再与有线因特网相连。如今许多家庭将宽带住宅接入(即电缆调制解调器或DSL)与廉价的无线局域网技术结合起来，以产生强大的家用网络。

广域无线接入：3G和LTE
手机设备应用了与蜂窝移动电话相同的无线基础设施，通过蜂窝网提供商运营的基站来发送和接收分组。与WiFi不同的是，一个用户仅需要位于基站的数万米范围内即可，而WiFi要求用户必须位于接入点的几十米范围内。

### 物理媒体

物理媒体分为导引型媒体(电波沿着固体媒体前行，如光缆、双绞铜线或同轴电缆)和非导引型媒体(电波在空气或外层空间中传播，如无线局域网或数字卫星频道中)。
- 双绞铜线：最便宜，用于高速LAN联网，以及住宅因特网接入(拨号调制解调器技术和DSL技术)
- 同轴电缆：主要用于电缆电视和电缆因特网接入
- 光纤：长途导引型传输媒体，特别是用于跨海链路
- 陆地无线电信道：无限LAN技术使用局域无线电信道，蜂窝接入技术使用广域无线电信道
- 卫星无线电信道：同步卫星、近地轨道卫星

## 1.3 网络核心

网络核心，即由互联因特网端系统的分组交换机和链路构成的网状网络。

### 分组交换

在各种网络应用中，端系统彼此交换报文，源将长报文划分为较小的数据块，称之为分组，在源和目的地之间每个分组都通过通信链路和分组交换机传送。

- 存储转发传输：多数分组交换机在链路的输入端使用存储转发传输，即在交换机能够开始向输出链路传输该分组的第一个比特之前，必须接收到整个分组。
- 排队时延和分组丢失：对于每条相连的链路，该分组交换机具有一个输出缓存(也称为输出队列)，如果到达的分组需要传输到某条链路，而该链路正忙于传输其他分组，该到达分组必须在输出缓存中等待，等待的时间就称为排队时延。如果该输出缓存已经满了，就会出现分组丢失，即丢包(packet loss)。
- 转发表和路由选择协议：每台路由器具有一个转发表，用于将目的地址(或目的地址的一部分)映射成为输出链路。路由选择协议用于设置这些转发表。

### 电路交换

电路交换网络中，在端系统间通信会话期间，预留了端系统间沿路径通信所需要的资源(缓存，链路传输速率)，即在两台主机要通信时，该网络首先在两台主机之间创建一条专用的端到端连接。

链路中的电路是通过频分复用或时分复用来实现的。对于频分复用(FDM, Frequency-Division Multiplexing)，链路的频谱由跨越链路创建的所有连接共享，在连接期间链路为每条连接专用一个频段，该频段的宽度称为带宽。对于时分复用(TDM, Time-Division Multiplexing)，时间被划分为固定期间的帧，并且每个帧又被划分为固定数量的时隙，当网络跨越一条链路创建一条连接时，网络在每个帧中为该连接指定一个时隙，这些时隙专门由该连接单独使用，在每个帧内的一个时隙可用于传输该连接的数据。

![](/zzimages/20230404201543.png)

分组交换的性能优于电路交换，因为电路交换不考虑需求，而预先分配了传输链路的使用，这使得已分配而并不需要的链路时间未被利用，而分组交换则按需分配链路使用，链路传输能力将在所有需要在链路上传输分组的用户之间逐分组地被共享。

## 1.4 分组交换网中的性能指标

### 时延

- 处理时延：检查分组首部和决定将该分组导向何处所需要的时间。
- 排队时延：在队列中分组在链路上等待传输的时间。设a表示分组到达队列的平均速率(单位为分组/秒，即pkt/s)，每个分组由L比特组成，链路传输速率为R bps，则称La/R为流量强度。如果流量强度大于1，则比特达到队列的平均速率超过从该队列传输出去的速率，于是排队队列趋向于无限增加，排队时延趋向于无穷大，所以设计系统时流量强度不能大于1
- 传输时延：将所有分组的比特推向链路(即传输，或者说发射)所需要的时间。用L比特表示该分组的长度，用R bps表示链路传输速率，则传输时延为L/R
- 传播时延：一个比特从一台路由器传播到另一台路由器所需要的时间。设两台路由器之间的距离为d，链路传播速率为s，则传播时延为d/s

### 吞吐量

吞吐量表示在单位时间内通过某个网络(或信道，接口)的数据量，即主机之间实际的传输速率。从主机A到主机B传送一个大文件，在任何时间的瞬时吞吐量是主机B接收到该文件的速率(bps)，如果该文件由F比特组成，主机B花费T秒全部接收，则文件传送的平均吞吐量是F/T bps.

对于简单的两链路网络，如果服务器不能以快于$R_s$ bps的速率注入比特，路由器不能以快于$R_c$ bps的速率转发比特，则吞吐量为$\min\{R_c,R_s\}$；类似地，如果是N链路网络(中间经过N-1台路由器)，则从服务器到客户的文件传输吞吐量是$\min\{R_1,R_2,\cdots,R_N\}$.

### 速率

速率(数据率、数据传输率、比特率)是连接在计算机网络上的主机在数字信道上传送数据位数的速率，即单位时间内传输的数据量，单位bps

### 带宽

带宽在模拟信号系统中表示信号所包含的各种不同频率成分所占据的频率范围，单位Hz；带宽在计算机网络中用来表示网络的通信线路传送数据的能力，通常是指单位时间内从网络中的某一点到另一点所能通过的最高数据率，单位bps。

### 时延带宽积

![](/zzimages/20230404202345.png)

### 往返时延RTT

![](/zzimages/20230404202359.png)

### 利用率

![](/zzimages/20230404202437.png)

### 丢包率

丢包率是指在一定时间范围内，传输过程中丢失的分组数量与总分组数量的比率。

## 1.5 协议层次及其服务模型

### 协议分层

各层的所有协议被称为协议栈，因特网的协议栈由5个层次组成：应用层、运输层、网络层、链路层、物理层。(事实上TCP/IP协议族是一个四层参考模型，将数据链路层和物理层合并称为网络接口层/数据链路层)

- 应用层：应用层是网络应用程序及它们的应用层协议存留的地方，位于应用层的信息分组称为==报文(message)==。应用层协议主要有HTTP(提供了Web文档的请求和传送)、SMTP(提供了电子邮件报文的传输)和FTP(提供两个端系统之间的文件传输)，除此之外，IP地址转换也是借助于特定的应用层协议DNS(域名系统)完成的。
- 运输层：运输层在应用程序端点之间传送应用层报文，运输层的分组称为==报文段(segment)==。
- 网络层：进行IP寻址及路由选择。网络层负责将称为==数据报(datagram)==的网络层分组从一台主机移动到另一台主机。
- 链路层：提供介质访问和链路管理。链路层将分组从一个节点移动到路径上的下一个节点，链路层分组称为==帧(frame)==。
- 物理层：主要定义物理设备的标准。物理层的作用是传输比特流，它将帧中的一个个比特从一个节点移动到下一个节点。

注：数据从发送端系统的协议栈向下，沿着中间的链路层交换机和路由器的协议栈上上下下，然后向上达到接收端系统的协议栈。其中链路层交换机只有物理层和链路层，而路由器只有物理层、链路层和网络层。在每一层，一个分组具有两种类型的字段：首部字段和有效载荷字段，有效载荷通常是来自上一层的分组。

### OSI模型

国际标准化组织ISO提出开放系统互联模型OSI，分为7层：应用层、表示层、会话层、运输层、网络层、数据链路层、物理层。会话层主要作用是建立、维护和管理会话，表示层主要作用是数据格式转换的数据加密。

## 1.6 网络安全

坏家伙能够经因特网将有害程序放入你的计算机中：至今为止的多数恶意软件是自我复制的，即一旦它感染了一台主机，就会从那台主机寻求进入因特网上的其他主机，从而形成新的感染主机，再寻求进入更多的主机。恶意软件能够以病毒或蠕虫的形式扩散，病毒是一种需要某种形式的用户交互来感染用户设备的恶意软件，而蠕虫是一种无须任何明显用户交互就能进入设备的恶意软件。

坏家伙能够攻击服务器和网络基础设施：拒绝服务攻击(Denial-of-Service (DoS) attack)使得网络、主机或其他基础设施部分不能由合法用户使用。大多数因特网DoS攻击属于以下三种类型之一：
- 弱点攻击：向一台目标主机上运行的易受攻击的应用程序或操作系统发送制作精细的报文，使该服务器可能停止运行，甚至主机崩溃。
- 带宽洪泛：攻击者向目标主机发送大量分组，使得目标的接入链路变得拥塞，从而使合法的分组无法到达服务器。
- 连接洪泛：攻击者在目标主机中创建大量的半开或全开TCP连接，该主机因这些伪造的连接而陷入困境，并停止接受合法的连接。

坏家伙能够嗅探分组：记录每个流经的分组副本的被动接收机称为分组嗅探器，最好的防御嗅探的方法基本上都与密码学有关。

坏家伙能够伪装成你信任的人：将具有虚假源地址的分组注入因特网的能力称为IP哄骗。

计算机网络安全的更多知识见书P385.

## 1.7 计算机网络和因特网的历史

1. 分组交换的发展：Roberts公布了一个ARPAnet的总体计划，它是第一个分组交换计算机网络，是今天的公共因特网的祖先。
2. 专用网络和网络互联：形成了互联网internet，本质上就是创建一个网络的网络。
3. 网络的激增：ARPAnet接受TCP/IP而选定因特网Internet为主要的计算机通信系统。
4. 因特网爆炸：万维网应用程序的出现将因特网带入世界上数以百万计的家庭和商业中。因特网采用三级结构，即主干网、地区网、校园网/企业网。
5. 多层次ISP结构：
![](/zzimages/20230404203311.png)
其中IXP是因特网交换点，多个ISP能够在这里一起对等(即能够将它们的网络连到一起，使它们之间的所有流量经直接连接而不是通过上游的中间ISP传输)。

# 第2章 应用层

## 2.1 应用层协议原理

### 2.1.1 网络应用程序体系结构

#### 客户-服务器体系结构(client-server architecture, C/S结构)

客户-服务器体系结构中，有一个总是打开的主机，即==服务器==，它服务于来自其他许多被称为==客户==的主机请求。服务器负责数据的管理，客户机负责完成与用户的交互任务。

- 在该体系结构中，客户之间是不直接通信的
- 服务器具有固定的、周知的IP地址
- 客户-服务器体系结构的著名应用有：Web、FTP、Telnet和电子邮件
- 通常如果仅有一台服务器处理所有的请求，那么服务器系统将很快变得不堪重负，为此，配备大量主机的==数据中心==常被用于创建强大的虚拟服务器，一个数据中心可以有数十万台服务器。
- C/S结构的优点是能充分发挥客户端PC的处理能力，很多工作可以在客户端处理后再提交给服务器，所以C/S结构客户端响应速度快；缺点是客户端需要安装专用的客户端软件，且对客户端的操作系统一般也会有限制，不能够跨平台。

B/S结构(browser-server, 浏览器-服务器)是Web兴起后的一种网络结构模式，Web浏览器是客户端最主要的应用软件。这种模式统一了客户端，将系统功能实现的核心部分集中到服务器上，简化了系统的开发、维护和使用。

- 优点：成本低、维护方便、分布性强、开发简单。
- 缺点：协议一般是固定的http/https，且客户端和服务器端的交互是请求-响应模式，通常动态刷新页面，响应速度明显降低。

#### P2P体系结构(Peer-to-Peer architecture)

在P2P体系结构中，对位于数据中心的专用服务器有着最小（或者没有）依赖。应用程序在间断连接的主机对之间使用直接通信，这些主机被称为==对等方==。对等方并不为服务提供商所拥有，因为这种对等方通信不需要通过专门的服务器，所以该体系结构也被称为对等方到对等方结构。

- 目前，流量密集型应用都是P2P体系结构的。这些应用包括文件共享（例如BitTorrent）、协助下载（例如迅雷）、因特网电话（例如Skype）和IPTV(例如迅雷看看)。
- 值得注意的是，某些应用具有混合的体系结构，它们结合了客户-服务器和P2P这两种体系结果，比如许多的即时通讯工具，服务器用来跟踪用户IP地址，但是用户之间的通信则使用直接发送。
- P2P体系结构最引人入胜的特性之一就是它们的==自扩展性==。比如在文件共享应用中，对等方可能通过向文件的原始拥有者发出请求而产生工作量，但是对等方也有可能通过为其他对等方传送文件而为原始拥有者分担压力；P2P体系结构也是成本有效的，因为他通常不需要庞大的服务器基础设施和服务带宽。

### 2.1.2 进程通信

在操作系统中，实际进行通信的是进程而不是应用程序；当进程运行在同一个端系统上时，它们使用进程间通信机制相互通信；而进程间通信的规则是由端系统上的操作系统确定的。当进程运行在不同的端系统上时，它们通过跨越计算机网络的报文相互通信；发送进程产生报文并且向网络中发送，接收进程接收报文并对此作出响应。

- 客户和服务器进程：在一对进程之间的通信会话场景中，发起通信的进程被标识为==客户==，在会话开始时等待联系的进程是==服务器==。
- 进程与计算机网络之间的接口：进程通过一个称为==套接字(socket)==的软件接口向网络发送报文和从网络接收报文。套接字是同一台主机内应用层和运输层之间的接口，由于该套接字是建立网络应用程序的可编程接口，因此套接字也被称为应用程序和网络之间的应用编程接口(API, Application Programming Interface)。应用程序开发者可以控制套接字在应用层的一切内容，但是对于运输层的相关部分，几乎没有控制权，可以做的只有选择运输层协议，以及设定几个运输层参数(如最大缓存和最大报文段长度等)。
- 进程寻址：为了向特定目的进程发送报文，发送进程需要知道接收进程的标记。该标记由两部分组成：接收进程所在的主机地址和接收进程在该主机中的标识符；在因特网中，主机由==IP地址==标记，其中IP地址是一个32位（IPV4）标记；而接收进程（准确地说是其对应的套接字）使用==端口号==标记，一些常用的应用程序有着固定的端口号，比如Web服务器使用80号端口、邮件服务器（运行SMTP协议）使用25号端口等。

### 2.1.3 可供应用程序使用的运输服务

可靠数据传输：如果一个协议能确保应用程序发送的数据正确、完全地交付给接收数据的进程，就称该协议提供了可靠数据传输。当应用程序使用可靠数据传输的传输层协议时，只要将要发送的数据传输进套接字就可以完全相信该数据可以完整无差错地到达接收方。当一个运输层协议不提供可靠数据传输时，由发送方发送的数据就可能不能够到达接收进程，有些应用是允许这样的情况发生的，这些应用被称为容忍丢失的应用，如交谈式音频和视频。

吞吐量：运输层协议能够提供确切的可用吞吐量。对吞吐量有明确要求的应用程序被称为带宽敏感的应用，而弹性应用则对吞吐量没有严格的要求。

定时：运输层协议也能提供定时保证，例如发送方注入进套接字中的每个比特到达接收方的套接字不迟于100ms

安全性：运输协议能够为应用程序提供一种或多种安全性服务。

### 2.1.4 因特网提供的运输服务

#### TCP服务

TCP服务模型包括了面向连接的服务和可靠数据传输服务。
- 面向连接的服务：在应用层数据报文开始流动之前，TCP会在客户端和服务器端相互交换运输层控制信息。这个握手过程将提示客户端和服务器端，让它们为即将到来的大量分组做好准备；握手阶段结束后将建立一个TCP连接，这条连接是全双工的，即连接双方的进程可以在此连接上同时进行报文收发。当应用程序结束报文发送时，必须拆除该连接。
- 可靠的数据传送服务：通信进程能够依靠TCP，无差错、按适当顺序交付所有发送的数据。
- 拥塞控制机制：当发送方和接收方之间的网络出现拥塞时，TCP将使用拥塞控制机制来抑制发送进程。

#### UDP服务

UDP服务是一种不提供不必要服务的轻量级运输协议，它仅提供最小服务。UDP是无连接的，UDP不提供数据的可靠传输，UDP也没有拥塞控制机制。

注：无论是TCP还是UDP都没有提供任何加密机制，但现在已经研制了TCP的加强版本，称为安全套接字层(SSL, Secure Sockets Layer)，这种强化是在应用层上实现的，而非运输层，SSL提供了安全性服务，包括加密、数据完整性和端点鉴别。

### 2.1.5 应用层协议

应用层协议定义了运行在不同端系统上的应用程序进程如何相互投递报文，协议主要定义了：
- 交换的报文类型，例如请求报文和响应报文
- 各种报文类型的语法，如报文中的各个字段及这些字段是如何描述的
- 字段的语义，即这些字段中的信息的含义
- 确定一个进程何时以及如何发送报文，对报文进行响应的规则

## 2.2 HTTP

### 2.2.1 HTTP概述

万维网(World Wide Web)的应用层协议是==超文本传输协议(HTTP, HyperText Transfer Protocol)==，它是Web的核心。HTTP由两个程序实现，一个客户程序和一个服务器程序。HTTP定义了客户和服务器进行报文交换的方法。

一些Web术语：==Web页面==(也叫文档)是由对象组成的，一个==对象==是一个文件，它们通过一个==URL==(统一资源定位符，Uniform Resource Locator)地址进行寻址，多数Web页面含有一个==HTML基本文件==(超文本标记语言，HyperText Markup Language)以及几个引用对象。==Web浏览器实现了HTTP的客户端，Web服务器实现了HTTP的服务器端==，它用于存储Web对象，每个对象由URL寻址(URL地址的一般形式是 <协议>://<主机>:<端口>/<路径> )。HTTP定义了Web客户向Web服务器请求Web页面的方式，以及服务器向客户传送Web页面的方式。

简要过程：==HTTP使用TCP作为它的运输层协议==，HTTP客户首先发起一个与服务器的TCP连接(==服务器端口号80==)，一旦连接建立，该浏览器和服务器进程就可以通过套接字接口访问TCP，于是客户向它的套接字接口发送HTTP请求报文，服务器从它的套接字接口接收HTTP请求报文然后向它的套接字接口发送HTTP响应报文，最终客户从它的套接字接口接收HTTP响应报文。需要注意的是，服务器根据请求作出响应，但是不存储任何关于该客户的状态信息，因此HTTP被称为==无状态协议==。同时，Web使用了客户-服务器的应用体系结构，其中Web服务器总是打开的。

### 2.2.2 非持续连接和持续连接

当通信使用TCP协议时，服务器端需要决定将每个请求通过一个单独的TCP连接发送还是将所有请求通过一个相同的TCP连接发送，前一种方式称为非持续连接，后一种方式则称为持续连接。HTTP既可使用持续连接也可以使用非持续连接，但在默认情况下HTTP使用持续连接。

#### 采用非持续连接的HTTP

使用非持续连接时，每个TCP连接在服务器发送一个对象后就会关闭，也就是每个TCP只传送一个请求报文和响应报文。我们定义==往返时间(RRT==, Round-Trip Time)，RTT指的是一个短分组从客户端到服务器然后再返回客户端所用的时间。因为客户端和服务器建立TCP连接的时候，会通过一个三次握手的过程来交换传输控制信息，即客户向服务器发送一个小TCP报文段，服务器用一个小TCP报文段做出确认和响应，最后客户向服务器返回确认。三次握手的前两次占用了一个RTT，客户结合第三次握手会通过该连接发送一个HTTP请求报文，一旦该分组到达服务器，服务器便开始使用TCP传输HTML文件。因此，粗略地说，从客户请求HTML文件到该客户收到整个文件所花费的时间是两个RTT加上HTML文件的传输时间。

#### 采用持续连接的HTTP

非持续连接的缺点在于：第一，必须为每个请求新建一个TCP连接，而每个TCP连接将占用系统资源，包括缓冲区和变量等，加重服务器负担；第二，一个对象将通过两个RTT的时延才能交付。如果使用持续连接，那么服务器在发送响应报文后将保持该TCP打开，后续客户端可以使用该连接来继续向服务器发出请求，同一台服务器上的多个页面也可以通过同一个连接发送。一般来说，如果一条连接在一定的时间间隔后没被使用的话，就会被关闭。

持续连接又分为非流水线和流水线两种方式：非流水线方式是指客户在收到前一个响应后才能发出下一个请求，而流水线方式则是客户每遇到一个对象引用就立即发出一个请求。==HTTP默认使用的是带流水线的持续连接==。

### 2.2.3 HTTP报文格式

#### HTTP请求报文

![](/zzimages/20230519161051.png)

例：
```http
GET /somedir/page.html HTTP/1.1
Host: www.someschool.edu
Connection: close
User-agent: Mozilla/5.0
Accept-language: fr

```

- 请求行有3个字段：==方法字段、URL字段和HTTP版本字段==。方法字段包括GET、POST、HEAD、PUT和DELETE。当浏览器请求一个对象时，使用GET方法，此时实体体为空；而当用户提交表单时，若使用POST方法，此时实体体中包含的就是用户在表单字段中输入的值，然而事实上HTML表单经常使用GET方法，并在所请求的URL中包括输入的数据，例如表单中填写了两个字段monkeys和bananas，于是使用GET方法的URL结构为
    ```
    www.somesite.com/animalsearch?  monkeys&bananas;
    ```
    HEAD方法类似于GET方法，当服务器收到一个使用HEAD方法的请求时，将会用一个HTTP报文进行响应，但是不返回请求对象，所以HEAD方法常用于调试跟踪；PUT方法允许用户上传对象到指定的Web服务器上指定的路径；DELETE方法允许用户删除Web服务器上的对象。
- Host：首部行指明了对象所在的主机
- Connection：首部行指明了是否使用持续连接，close代表使用非持续连接
- User-agent：首部行指明用户代理，即向服务器发送请求的浏览器的类型
- Accept-language：首部行表示用户想得到该对象的语言版本，fr表示法语

#### HTTP响应报文

![](/zzimages/20230519161933.png)

例：
```http
HTTP/1.1 200 OK
Connection: close
Date: Tue, 18 Aug 2015 15:44:04 GMT
Server: Apache/2.2.3 (CentOS)
Last-Modified: Tue, 18 Aug 2015 15:11:03 GMT
Content-Length: 6821
Content-Type: text/html

(data data …)
```
- 状态行有3个字段：协议版本字段、状态码和相应状态信息。常见状态码和状态信息如下：
    - 200  OK：请求成功，信息在返回的响应报文中(实体体中包含了所请求的对象本身)
    - 301  Moved Permanently：请求的对象已经被永久转移了，新的URL定义在响应报文的Location：首部行中，客户软件将自动获取新的URL
    - 400  Bad Request：一个通用差错代码，指示该请求不能被服务器理解
    - 404  Not Found：被请求的文档不在服务器上
    - 505  HTTP Version Not Supported：服务器不支持请求报文使用的HTTP协议版本
- Connection：首部行指明了是否使用持续连接
- Date：首部行指示服务器产生并发送该响应报文的时间
- Server：首部行指示该报文是由一台Apache Web服务器产生的
- Last-Modified：首部行指示了对象创建或者最后修改的时间
- Content-Length：首部行指示了被发送对象中的字节数
- Content-Type：首部行指示了实体体中的对象是HTML文本

### 2.2.4 用户与服务器的交互：cookie

HTTP是无状态协议，但是Web站点为了识别用户身份或者限制用户访问的时间或者将用户访问的内容同用户身份相关联，因此HTTP使用了cookie，它允许站点对用户进行跟踪。cookie技术包含4个组件： ==HTTP响应报文里增加一个关于cookie的首部行；HTTP请求报文里增加一个关于cookie的首部行；用户端系统保留一个cookie文件，并由用户的浏览器进行管理；Web站点建立一个后端数据库用于cookie和用户身份的关联==。

![](/zzimages/20230519162358.png)

上图是一个简要的cookie跟踪过程，假设用户已访问过ebay站点，然后首次与amazon.com联系，于是Web站点产生一个唯一识别码1678(用于标识该用户)，并以此作为索引在它的后端数据库中产生一个表项，然后用一个包含Set-cookie：1678首部行的HTTP响应报文对用户的浏览器响应，用户接收到响应报文后浏览器就会在它管理的特定cookie文件中添加一行包含服务器的主机名和识别码的表项。当用户再次浏览amazon网站时，每请求一个Web页面，其浏览器就会查询cookie文件并抽取对这个网站的识别码，并放到HTTP请求报文中包含识别码的cookie首部行中。于是amazon服务器就可以跟踪该用户在amazon站点中的所有活动。

### 2.2.5 Web缓存

==Web缓存器==(Web cache)也被称为==代理服务器==，它是能够代表初始Web服务器来满足HTTP请求的网络实体。它有自己的磁盘存储空间，并在存储空间里保持有最近请求过的对象的副本。可以通过配置浏览器，将所有指向初始服务器的请求首先指向代理服务器。

具体过程：浏览器首先创建一个到Web缓存器的TCP连接，并向Web缓存器中的对象发送一个HTTP请求；当Web缓存器收到一个HTTP请求后，它将检查本地是否缓存过该对象的副本，如果缓存过该对象，将检查是否过期，如果没有过期，则直接将该对象返回给浏览器；如果本地不存在或者存在已过期，则Web缓存器就打开一个与该对象的初始服务器的TCP连接，根据请求报文里的Host首部行以及请求行里的URL字段向初始服务器发出HTTP请求，然后将响应对象返回给浏览器并缓存在本地。

- 通常，代理服务器与客户端的通信速度要快于初始服务器与客户端的连接速度，而且缓存器能从整体上大大降低因特网上的Web流量，从而有助于提高所有应用程序的性能。
- 注意到Web缓存既是客户又是服务器。通过使用内容分发网络(CDN, Content Distribution Network)，Web缓存器正在因特网中发挥越来越重要的作用。
- HTTP提供了一种机制，允许缓存器证实其使用的对象是最新的，这种机制就是==条件GET==方法。只需在使用GET方法的时候，增加一个If-Modified-Since首部行，其对应的内容是一个时间，如果Web缓存器向服务器所请求的资源在该指定时间后被修改了，那么服务器将返回新的对象，否则服务器将返回一个包含空实体体的响应报文(状态信息为304  Not Modified)，这样代理服务器就可以确认缓存是否过期了。

## 2.3 FTP

### 2.3.1 FTP的工作原理

文件传输协议(File Transfer Protocol, FTP)提供以下功能：
- 提供不同种类主机系统之间的文件传输能力
- 以用户权限管理的方式提供用户对远程FTP服务器上的文件管理能力
- 以匿名FTP的方式提供公用文件共享的能力

FTP采用客户-服务器的体系结构，使用TCP可靠的传输服务。一个FTP服务器进程可同时为多个客户进程提供服务，FTP服务器进程由两大部分组成：一个主进程，负责接收新的请求；另外有若干从属进程，负责处理单个请求。在一个典型的FTP应用中，用户通过FTP代理和FTP交互，用户首先提供远程主机的主机名，使得FTP用户代理建立一个到远程主机的TCP连接，之后需要用户提供用户名和密码，它们作为FTP命令的一部分在TCP连接上传输，一旦服务器授权，用户便可以和服务器进行文件传输了(匿名FTP访问通常使用anonymous作为用户名)。工作步骤如下：

1. 打开控制端口21，使客户进程能够连接上
2. 等待客户进程发送连接请求
3. 启动从属进程来处理客户进程发来的请求。主进程和从属进程并发执行，从属进程对客户进程的请求处理完毕后即终止
4. 回到等待状态，继续接收其他客户进程的请求

### 2.3.2 控制连接与数据连接

FTP使用两个并行的TCP连接来传输数据，一个TCP被称为==控制连接(端口号21)==，用来传输FTP控制命令；一个TCP连接被称为==数据连接(主动模式下端口号为20)==，用于传输文件数据。因为FTP协议内，控制信息是通过一个独立的TCP连接传输，所以我们称FTP的控制信息是带外传送的；如果控制信息和数据信息通过同一个TCP传输，则称为带内传送。

#### 控制连接

FTP中控制连接贯穿整个会话，但是数据连接会在一个文件开始传输的时候建立，在传输结束后关闭。所以每次传输一个新的文件时，都会新建一个数据连接。FTP需要在整个会话期间，保留用户的状态，也就是将控制连接同用户账户关联起来，同时记录用户在远程目录树上的操作，这就限制了FTP可以同时维持的会话总数。

FTP命令和回答：从客户到服务器的命令和从服务器到客户的回答，都是以7比特ASCII格式在控制连接上传递的。

常见的命令：

|命令|作用|
|---|---|
|RETR \<filename\>| 从服务器上找回(复制)文件|
|STOR \<filename\> |储存(复制)文件到服务器上|
|USER \<username\>|系统登录的用户名|
|PASS \<password\>|系统登录密码|

常见的回答：

|回答|作用|
|---|---|
|125|打开数据连接，开始传输|
|331|要求密码|
|452|磁盘空间不足，写错误|
|425|无法打开数据连接|

#### 数据连接

数据连接有两种传输模式：主动模式PORT和被动模式PASV

- PORT模式的工作原理：客户端连接到服务器的21端口，登录成功后要读取数据时，客户端随机开放一个端口，并发送命令告知服务器，服务器收到PORT命令和端口号后，通过20端口与客户端开放的端口连接，发送数据。
- PASV模式的工作原理：客户端要读取数据时，发送PASV命令到服务器，服务器在本地随机开放一个端口，并告知客户端，客户端再连接到服务器开放的端口进行数据传输。

## 2.4 SMTP

因特网电子邮件系统有三个核心组件：用户代理、邮件服务器、简单邮件传输协议(SMTP, Simple Mail Transfer Protocol）。邮件服务器构成了电子邮件系统的核心，每个收发方在邮件服务器上拥有一个邮箱。一个典型的电子邮件发送过程为：发送方通过用户代理将邮件传送到发送方的邮件服务器，再传输到接收方的邮件服务器，然后邮件被分发到接收方的邮箱里，最后接收方从邮件服务器里获取自己的邮件(需要通过邮件服务器的验证)。如果发送端不能将邮件发送给接受端的服务器，发送端的邮件服务器会在一个报文队列中保持该报文并在以后尝试再次发送。

### 2.4.1 SMTP

SMTP是因特网中电子邮件的主要应用层协议，它使用TCP可靠数据传输从发送方的邮件服务器向接收方的邮件服务器发送邮件。在每台邮件服务器上既可以运行SMTP服务器，也可以运行SMTP客户端。

简要过程：Alice调用她的邮件代理程序并提供Bob的邮件地址，撰写报文，然后指示用户代理发送该报文到她的邮件服务器，在那里该报文被放在报文队列中。接下来就是SMTP协议的运行过程，运行在Alice的邮件服务器上的SMTP客户端发现了报文队列中的这个报文，于是在==25号端口==建立一个到SMTP服务器端(即Bob的邮件服务器)的TCP连接，连接建立后，服务器和客户执行某些应用层的握手，比如SMTP客户指示发送方的邮件地址和接收方的邮件地址；然后SMTP依赖TCP提供的可靠数据传输无差错地将邮件投递到接收服务器；该客户如果有另外的报文要发送到该服务器，就在该相同的TCP连接上重复这种处理(可见SMTP是持续连接的)，否则就指示TCP关闭连接。最后Bob的邮件服务器将该报文放入Bob的邮箱中，在Bob方便的时候他可以调用用户代理阅读该报文。

![](/zzimages/20230519191539.png)

SMTP报文一般不使用中间邮件服务器发送报文，即使这两个邮件服务器位于地球的两端也是这样。

SMTP与HTTP的对比：SMTP和HTTP都是用TCP协议，且SMTP和默认的HTTP都是用持续连接，但是两者也有区别：
- 首先HTTP被设计为一个拉协议而SMTP被设计为一个推协议。即用户通过HTTP主动向服务器请求内容，而SMTP则是客户将内容推向服务器端。
- 第二个区别就是SMTP要求每个报文都采用7比特ASCII码格式，而HTTP不受这种限制。(为了传送非ASCII码，提出了多用途网络邮件扩充(MIME, Multipurpose Internet Mail Extensions)作为对SMTP的扩充，使得传输内容更丰富多彩，它可以将传输内容先转换成7位ASCII编码，然后再经由SMTP进行传输)
- 第三个重要区别就是，HTTP将每个对象封装在自己的响应报文里，而SMTP则将所有的报文对象放到一个报文之中。

邮件报文格式：
![](/zzimages/20230519191719.png)
报文由两部分组成：一个包含环境信息的首部(如上图)和一个包含邮件内容的报文体。首部和报文体之间使用空行分开。首部行的格式为关键字：及其值；每个首部必须包含一个From和To首部行(@前面的是用户名，@后面的是邮箱所在主机的域名)。首部也可以包含其它信息，比如Subject(邮件的主题)等。

### 2.4.2 邮件访问协议

==SMTP是邮件服务器之间发送邮件报文的协议，并不是用户通过代理和邮件服务器之间通信的协议==。用户代理使用==邮件访问协议==来从邮件服务器上获取邮件信息，目前常用的邮件访问协议有第三版的邮局协议（POP3，Post Office Protocol-Version 3）、因特网邮件访问协议（IMAP，Internet Mail Access Protocol）和HTTP。

![](/zzimages/20230519191912.png)

#### POP3

POP3是一个非常简单的协议，当用户代理打开了一个到邮件服务器端口110上的TCP连接后，POP3就开始工作了。POP3按照三个阶段进行工作：特许、事务处理和更新。在特许阶段，用户代理发送密码和用户名，进行身份鉴别；第二阶段，用户代理取回报文，同时还可以对报文做删除标记、取消报文删除标记以及获取邮件的统计信息；第三个阶段是在用户退出后，POP3结束会话，删除被标记的邮件。

POP3用户代理可以使用两种事务处理模式：一种是下载并删除，另一种是下载并保留。下载并删除的方法存在的问题是，如果用户在一台设备上查看了邮件（下载了邮件）后，邮件将被删除，那么在其他设备上将无法查看邮件。使用下载并保留方式，则用户下载邮件后，邮件还在服务器上。

#### IMAP

POP3协议无法为用户提供邮件分类管理的功能，虽然用户可以通过将邮件下载到本地，然后由用户代理程序做分类管理，但是处理的结果是无法同步到其他查看设备上的。为了解决这一问题，IMAP诞生了。IMAP将每个报文和一个文件夹联系起来，当报文第一次到达服务器时，它与收件人的INBOX相关联。收件人可以将邮件移到新创建的文件夹，阅读邮件，删除邮件等。IMAP允许用户在远程文件夹里移动邮件并且查询邮件。值得注意的是，IMAP服务器维护了IMAP会话的用户状态信息，但是POP3并不；IMAP协议还允许用户代理获取报文某些部分的命令而不是报文整体。

#### 基于Web的电子邮件

使用这种服务，用户代理就是普通的浏览器，用户和他远程邮箱之间的通信则通过HTTP进行。当Bob想从他的邮箱中访问一个报文时，该电子邮件报文从Bob的邮件服务器发送到他的浏览器，使用的是HTTP协议。当Alice要发送一封电子邮件报文时，该电子邮件报文从Alice的浏览器发送到她的邮件服务器，也使用HTTP协议。然而Alice的邮件服务器和Bob的邮件服务器之间发送和接收邮件仍然使用SMTP协议。

## 2.5 DNS

### 2.5.1 DNS提供的服务

域名系统（DNS，Domain Name System）是一个由分层的DNS服务器实现的分布式数据库，也是一个使得主机可以查询分布式数据库的应用层协议。==DNS运行在UDP之上，使用53号端口==。DNS通常被其他应用层协议使用，比如：HTTP、SMTP和FTP等。除了提供==主机名到IP地址的转换==外，DNS还提供以下重要服务：
- 主机别名：虽然主机名比起IP地址好记多了，但是有时候我们的主机名仍然很长不好记忆，所以我们需要为主机名再起一个名字，这就是主机别名，DNS不但提供主机名到IP地址的转换服务，还提供主机名与主机别名的转换，此时主机名被称为规范主机名。
- 邮件服务器别名：DNS同样也提供邮件服务器主机名和别名的转换服务，实际上，MX记录允许一个公司的邮件服务器和Web服务器可以使用相同的主机别名。
- 负载分配：DNS也被用在冗余的服务器之间分配负载。每个服务器有着不同的IP地址，但是它们都和同一个主机名相关联，也就是一个IP地址集合与同一个规范主机名相联系。当某个DNS服务器收到DNS请求时，该服务器将使用IP地址的整个集合作为响应，但是在每个应答中，循环这些IP地址的次序。

### 2.5.2 层次域名空间

如www\.baidu\.com中，标号com是顶级域名，标号baidu是二级域名，标号www是三级域名。

- 标号中的英文不区分大小写，除连字符-外不能使用其他的标点字符
- 每个标号不超过63个字符，多标号组成的完整域名最长不超过255个字符
- 级别最低的域名写在最左边，级别最高的域名写在最右边
- 顶级域名分为如下三类：
    - 国家(地区)顶级域名：如.cn表示中国
    - 通用顶级域名：.com(公司)、.net(网络服务机构)、.org(非营利性组织)、.gov(国家或政府部门)等
    - 基础结构域名：只有.arpa一个，用于反向域名解析，因此又称反向域名

### 2.5.3 DNS工作机理概述

当主机上的DNS客户端收到一个转换请求时，客户端将向网络发送一个DNS查询报文，然后客户端将收到一个包含相关信息的DNS回答报文，这个报文里有客户端想要的内容，之后DNS客户端将IP地址返回给请求的提出者即可。从使用DNS服务的请求者来看，DNS就像一个简单的提供直接转换服务的黑盒子，实际上这个黑盒子非常复杂，由分布在全球的大量DNS服务器以及定义DNS服务器和查询主机之间如何通信的应用层协议组成。DNS采用分布式的设计方案，实际上，DNS是一个在因特网实现分布式数据库的精彩范例，而之所以这样做，是因为单一的DNS服务器无法解决单点故障、无法保证通信容量以及无法邻近所有的查询主机和维护困难等问题。

#### 分布式、层次数据库

为了处理扩展性问题，DNS服务器采用层次式组织，并且分布在全世界范围内，大致来说，存在三种DNS服务器：根DNS服务器、顶级域(TLD, Top-Level Domain)DNS服务器和权威DNS服务器。举例说明，其工作的普遍流程：一个DNS客户端，希望获得www\.baidu\.com的IP地址，粗略的说，DNS客户端首先和根DNS服务器之一取得联系，它将返回负责解析顶级域名com的服务器的IP地址（或者其集合），客户将同这些服务器之一取得联系，然后顶级域DNS服务器建返回baidu\.com的权威服务器的IP集合，客户端通过与这些服务器之一取得联系，获得www\.baidu\.com的IP地址。
- 根DNS服务器：因特网上有13个组织管理400多个根DNS服务器，它们提供TLD服务器的IP地址
- 顶级域DNS服务器：负责顶级域名，如com，org，net，edu，gov以及各个国家的顶级域名的转换。TLD服务器提供了权威DNS服务器的IP地址。
- 权威DNS服务器：因特网上，具有公共可访问主机的每个组织机构必须提供公共可访问的DNS记录，这些记录将主机名映射为IP地址。一个组织的权威DNS服务器收藏了这些DNS记录，多数大学和大公司实现和维护它们自己的基本和辅助（备份）权威DNS服务器。

除了上面三种DNS服务器，还有一种不在DNS层次结构之中，但是很重要的DNS，是==本地DNS服务器==。本地DNS服务器通常邻近其所在网络的其他主机。当主机发出DNS请求时，该请求被发往本地DNS服务器，它起着代理的作用，并将请求转发到DNS服务器层次结构中。

![](/zzimages/20230519202459.png)

DNS查询有两种，一种是递归查询一种是迭代查询。实践中，查询通常满足这样的模式：从请求主机到本地DNS服务器的查询是递归的，其余查询是迭代的(图2-18)。像图2-19中是全部采用递归查询，这种方法在实际中几乎不使用。注意上述dns\.umass\.edu直接返回了gaia\.cs\.umass\.edu的IP地址，但有时候往往在dns\.umass\.edu中只存储了dns\.cs\.umass\.edu的IP地址，于是需要再次询问dns\.cs\.umass\.edu才能得到gaia\.cs\.umass\.edu的IP地址。

#### DNS缓存

DNS缓存原理十分简单，每当DNS服务器发出请求后收到回答时，就将回答的内容缓存在它自己的主机空间上。这样，如果有相同的请求到达时，就不需要再去发出请求，直接使用缓存即可；因为有了缓存，本地DNS就可以直接提供一些经常被访问的主机名所对应的IP地址，而不需要询问根DNS服务器了。事实上，在用户主机中也会有DNS缓存。需要注意的是，由于主机名与IP地址间的映射并不是永久的，所以DNS服务器在一段时间后(通常设置为两天)将丢弃缓存的信息。

### 2.5.4 DNS记录和报文

共同实现分布式数据库的所有DNS服务器存储了资源记录(RR，Resource Record)。RR提供了主机名到IP地址的映射，一条RR是具有以下字段的4元组：(Name, Value, Type, TTL)，其中TTL是指该记录的生存时间，它决定了该条记录何时被删除。Name和Value的值取决于Type：
- type=A：则name为主机名，value为对应的IP地址；
- type=NS：则name为域，value为如何获得该域下主机IP地址的权威DNS服务器的主机名，例如(foo.com, dns.foo.com, NS)；
- type=CNAME：则value为name（主机别名）所对应的主机的规范主机名；
- type=MX：则value为name(邮件服务器别名)所对应的邮件服务器的规范主机名, 如(foo.com, mail.bar.foo.com, MX)；

因此，如果一台DNS服务器是用于某特定主机名的权威DNS服务器，那么该DNS服务器会有一条包含用于该主机名的类型A记录；如果不是用于某主机名的权威服务器，那么该DNS服务器将包含一条类型NS记录，该记录对应于包含主机名的域，除此之外它还将包含一条类型A记录，该记录提供了在NS记录的Value字段中的DNS服务器的IP地址。

#### DNS报文

DNS报文有两种，即查询报文和回答报文，并且两种报文有着相同的结构：

![](/zzimages/20230519203034.png)

- 前12字节为首部区域。标识符是一个用来标识该查询的16比特数，该标识符会被复制到相应的回答报文里，以便匹配请求和回答；标志字段有若干标志，用来指出报文的类型（查询还是回答）、查询类型（递归还是迭代）、是否是所请求名字的权威DNS服务器；首部中还有4个有关数量的字段，用来指示首部后的4类数据区域出现的数量；
- 问题区域包含了正在进行的查询信息，包括名字字段(正在被查询的主机名)、类型字段(A、NS、CNAME、MX)；
- 回答区域包含了对最初请求的名字的资源记录，回答报文的回答区域可以包含多条RR，因此一个主机名能有多个IP地址；
- 权威区域包含了其他权威服务器的信息；
- 附加区域包含了其它有帮助的记录，比如在对于一个MX类型的请求回答报文里，回答区域里指出了邮件服务器的规范主机名，而附加区域里就有可能包含一个类型为A的关于该规范主机名的的IP地址。

在DNS数据库中插入记录：需要在注册登记机构完成这一任务，当你注册一个域名时，需要向该机构提供你的基本和辅助DNS服务器的名字和IP地址，该注册机构将确保一个类型为NS和类型为A的记录输入对应的顶级域名服务器，这样就完成了插入数据。

## 2.6 P2P应用

使用P2P体系结构，对总是打开的基础设施服务器没有依赖，成对间歇连接的主机之间相互通信。有两种典型因特网应用十分适合P2P体系结构，一种是文件分发（BitTorrent)，另一种是大型对等方社区中的数据库。P2P体系结构有着良好的自扩展性，这种扩展性的直接成因是：对等方除了比特的消费者之外还是他们的重新分发者。我们将详细介绍P2P文件分发。

BitTorrent是一种用于文件分发的流行P2P协议。用BitTorrent的术语来说，参与一个特定文件分发的所有对等方的集合被称为一个洪流，在一个洪流中的对等方彼此下载等长度的文件块。当一个对等方下载文件块的时候，也向其他对等方发送了多个块。一旦某对等方获得了完整文件，就可以自私地离开洪流或者大公无私地留下来继续向其他对等方发送文件。

P2P文件共享协议，参与一个特定文件分发的所有对等方结合被称为一个洪流（torrent），在一个洪流的对等方彼此下载等长度的文件块，可以随时离开洪流，也可继续向其他对等方上载。每个洪流都有一个追踪器。

Alice加入某洪流时，会在追踪器里进行注册，周期性通知追踪器它仍在洪流中。我们称所有与Alice成功的创建了一个TCP链接的对等方成为邻近对等方。洪流随机从参与对等方的结合中选择一个子集，将他们的IP地址发给Alice，Alice维护这张对等方列表，试图与所有对等方建立并行的TCP连接。Alice周期询问每个邻近对等方（连上的）他们有的文件块列表，她随时知道邻居有哪些文件块。Alice使用最稀缺优先技术，首先请求那些邻居们副本数量最少的块，使该文件块迅速分发，以均衡每个块在洪流中的副本数量。BitTorrent使用一种算法，Alice优先从向她传时速度最快的邻居（4个，每10s修改一次）那里获取文件块。每过30s，Alice也要随机选择另外一个对等方Bob，向他发送块。若Alice是Bob最快的前四快，Bob也是Alice的前4快，则Bob和Alice互相发送数据。每过30s换一个新的对象，互相交换数据（一报还一报），为了使对等方能够找到彼此协调的速率上传。


# 第3章 运输层

## 3.1 概述和运输层服务

运输层协议为运行在不同端系统上的应用==进程==之间提供逻辑通信功能(==即端到端通信，端指的是端口==)。运输层协议是在端系统中实现的而不是在路由器中实现的。运输层接收来自应用层的报文，将其划分为较小的块并为每块添加运输层首部以生成运输层==报文段==，然后在发送端系统中，运输层会将这些报文段交给网络层，网络层将其封装成网络层数据报，然后向目的地发送。

### 3.1.1 运输层和网络层的关系

网络层提供==主机之间==的逻辑通信，而运输层为运行在不同主机上的应用==进程==提供逻辑通信。运输层协议只工作在端系统中。在端系统中，运输层协议将来自应用进程的报文移动到网络边缘即网络层，反过来也从网络层接收这些报文段，但运输层对报文段如何在网络核心中传输并不做干涉。

### 3.1.2 因特网运输层概述

因特网为应用层提供了两种运输层协议：UDP(用户数据报协议, User Datagram Protocol)它提供一种不可靠、无连接的服务，==UDP是一种报式协议==；另一种是TCP(传输控制协议, Transmission Control Protocol)，它提供可靠的、面向连接的服务，==TCP是一种流式协议==。

因特网网络层协议有一个名字叫IP，即网际协议。IP为主机间提供逻辑通信，IP的服务模型是==尽力而为交付==服务，这意味着==它不保证报文段的交付、不保证报文段按序交付、不保证报文段中数据的完整性==，即IP提供一种不可靠的服务。

UDP和TCP最基本的责任就是将IP提供的主机间交付服务扩展到不同端系统上两个进程间的交付服务，这也被称为运输层的==多路复用和多路分解==。UDP和TCP通过在其报文段首部添加差错检查字段来提供完整性检查，进程到进程之间的==数据交付==和==差错检查==是最低限度的两种运输层服务，也是UDP可以提供的仅有的两种服务。而TCP还提供额外的==可靠数据传输==和==拥塞控制==服务。

### 3.1.3 多路复用和多路分解

一个进程有一个或多个套接字(socket)，它相当于网络和进程间传递数据的门户，在接收主机中的运输层实际上并没有直接将数据交付给进程，而是将数据交给了一个中间的套接字。每个运输层报文段中有几个字段，接收端运输层检查这些字段，标识出接收套接字，进而将报文段定向到该套接字。将运输层报文段中的数据交付到正确的套接字的工作称为==多路分解==；在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层的工作称为==多路复用==。

每个套接字有唯一标识符，称为==端口号==；每个报文段有特殊字段来指示该报文段所要交付到的套接字，这些字段是==源端口号字段==和==目的端口号字段==。端口号大小在0-65535之间，其中0-1023属于周知端口号，它们为特定的socket所有；1024-49151属于登记端口号，必须在IANA按照规定的手续登记；49152-65535留给用户进程选择暂时使用。
![](/zzimages/20230521154148.png)

#### 无连接的多路复用与多路分解

创建一个UDP套接字时，运输层自动地为该套接字分配一个端口号(通常客户端是自动分配的端口号，而周知协议的服务器端则分配一个特定的端口号)。==一个UDP套接字是由一个IP地址和端口号即二元组来标识的==，所以如果两个UDP报文段有不同的源IP地址或者源端口号，但是有相同的目的IP和目的端口号的话，它们在服务器端将通过同一个socket到达同一个应用程序。

#### 面向连接的多路复用与多路分解

==TCP套接字是通过一个四元组来标记的：(源IP地址，源端口号，目的IP地址，目的端口号)==，所以两个具有不同源IP地址或者源端口号，但有相同的目的IP地址和目的端口号的TCP报文段将通过两个不同的socket进入同一应用进程，这也表示一个应用进程可以关联多个socket，而一个socket将只关联一个应用进程。常常，这样的对应关系是通过线程来实现的，即一个进程有多个线程，而每个线程关联了一个socket。

## 3.2 UDP

### 3.2.1 UDP的优点

- 关于何时、发送什么数据的应用层控制更为精细：这是因为一旦应用程序将数据交给UDP，UDP就会打包将其发送给网络层，不会受到运输层的调节，这在一些实时应用中比较实用。当然，应用程序还可以通过UDP+自主开发一些功能的模式来扩展UDP。
- 无需建立连接：所以就不会引入额外的时延，这也可能是DNS使用UDP而不是TCP的主要原因。
- 无需维护连接状态：TCP为了实现可靠数据传输和拥塞控制需要在端系统中维护一些参数，而UDP因为不建立连接，所以自然也就不需要维护这些状态。
- 分组首部更小：TCP报文段有20字节的首部开销，而UDP只有8字节。
- UDP支持一对一、一对多、多对一、多对多的交互通信，UDP常用于一次性传输较少数据的网络应用。

![](/zzimages/20230521160902.png)

不过在UDP之上运行多媒体应用是有争议的，因为UDP没有拥塞控制协议，所以其对网络有很大的威胁性：大量的UDP流量将使网络过度拥塞而造成TCP连接几乎无法传输数据，并且因为网络拥塞造成较高的丢包率，于是UDP很有可能继续发送数据使得网络效率更加低下。需要注意的是，使用UDP仍然可以实现可靠数据传输，只不过这一部分功能需要在应用程序中自主开发，将可靠性直接构建于应用程序中，将使其既可以可靠地传输数据又可以避免受制于TCP的拥塞控制（传输速率的控制）。

### 3.2.2 UDP报文段结构

![](/zzimages/20230521160955.png)

UDP首部只有4个字段，每个字段占用两个字节，分别是：源端口号、目的端口号、长度和校验和。其中，==长度表示UDP报文段长度(首部加数据)，以字节为单位；校验和字段用来计算报文段在传输的过程中是否出现了差错==。一种常见的校验和的计算方法是：首先在UDP报文段前临时添加12字节的伪首部(仅为了计算校验和，并不会发送，伪首部由以下字段构成：4字节的源IP地址，4字节的目的IP地址，1字节的全0，1字节的17(用于表示十进制数17的二进制数)，2字节的UDP长度)，然后发送方将每16比特字(包括所有伪首部、首部、数据部分)做按位加运算，然后计算结果(溢出的高位直接舍去)取反作为校验和，注意如果数据部分不是偶数个字节，则计算校验和时需要在数据部分末尾填入一个全0字节，但此字节并不发送；然后接收方按同样的做法，对每16比特字做按位加运算，如果没有出现差错，则最后的结果每位全是1，否则就表明出现了错误。(源端口号和校验和字段是可选的，不需要时直接令该字段为全0，所以如果使用校验和字段且恰巧计算出来校验和为全0，则规定将全1填入校验和字段，相应检错规则也要修改)

UDP作为运输层协议必须提供==差错检测==功能，这是由于不能保证源和目的地之间所有链路都提供差错检测功能。所以要实现端到端的差错检测，就必须在运输层协议中实现该功能，这一原则在系统设计中被称为==端到端原则==："因为某一功能必须在端到端实现，与在较高层次提供这些功能的代价相比，在较低层次上设置的功能可能是冗余的，或者根本是没有用的"。注意UDP可以检测差错，但是无法恢复差错，能做的除了将其丢弃外，便是将其交给应用程序并给出警告。

注意UDP是面向报文的(而TCP是面向字节流的)，即发送方UDP对应用层交下来的报文，在添加首部后就向下交付给IP层，==UDP既不拆分报文，也不合并报文==，因此应用程序要选择合适大小的报文，否则IP层会做相应处理，导致IP层效率降低。

## 3.3 可靠数据传输原理

### 3.3.1 停等协议(stop-and-wait)

源端发送单个报文段后必须等待确认，在目的端的回答到达源端之前，源端不能发送其他的报文段。利用检验和、序号、定时器、肯定(和否定)确认分组来实现可靠传输。

![](/zzimages/20230521161424.png)

### 3.3.2 回退N步协议(GBN, Go-Back-N)

![](/zzimages/20230521161501.png)

GBN协议允许发送方发送多个分组(这也称为流水线技术)，具体而言，发送方维护一个大小为N的滑动窗口，其中基序号定义为最早未确认分组的序号，下一个序号定义为最小的未使用序号。

![](/zzimages/20230521161530.png)

- 当上层调用调用发送接口时，发送方首先检查窗口是否已满(即是否有N个已发送但未被确认的分组)，如果未满则产生一个分组并发送，如果已满则先暂时缓存该分组等待窗口滑动。
- GBN协议采取==累积确认==的方式，即接收方发送对序号n的肯定确认，表示接收方已正确接收到序号n及之前的所有分组。所以如果收到一个不按序的分组(如上图收到分组3)，则接收方直接丢弃该分组，并为最近按序接收到的分组重新发送ACK。
- 如果出现超时，则发送方重传所有已发送但还未被确认的分组。
- 注意发送方需要维护一个大小为N的窗口，而接收方的窗口大小只需为1。除此之外，窗口大小N与序号范围也有关系，具体而言，如果用n个比特编号，则窗口大小N需要满足$N\leq 2^n-1$.

### 3.3.3 选择重传协议(SR, Selective Repeat)

选择重传协议通过让发送方仅重传丢失或受损的分组而避免了不必要的重传。这种个别的、按需的重传要求接收方逐个地确认正确接收的分组。SR接收方将确认一个正确接收的分组而不管其是否按序，所以接收方也需要一个大小为N的窗口，失序的分组将被缓存直到所有序号更小的分组皆被收到为止，这时才可以将一批分组按序交付给上层。

![](/zzimages/20230521161811.png)

注意如果上图中第一个返回ACK0的确认丢失了，则之后发送方会重传0号分组，即使此时接收方的滑动窗口内已没有0号分组，也同样需要返回ACK0以作确认。同样要注意窗口大小N与序号范围有关系，如果用n个比特编号，则窗口大小N需要满足$N\leq 2^{n-1}$.

## 3.4 面向连接的运输：TCP

### 3.4.1 TCP连接概述

TCP被称为是面向连接的，该连接是一条逻辑连接，其连接状态仅保留在两个通信端系统的TCP程序中，中间的分组交换机对TCP连接视而不见，它们看到的是数据报/帧，而不是连接。

TCP提供==全双工服务==，即数据从A到B的同时，也能从B到A。TCP协议无法提供多播服务，一条TCP连接只关联一个发送方和接收方。

TCP连接建立的简要过程：客户首先发送一个特殊的TCP报文段给服务器；服务器收到该报文段后，用另一个特殊的TCP报文段来响应；最后发送方接收到响应报文段后，发送第三个报文段，其中包含了有效负载(即应用层数据)。这种连接建立过程被称为==三次握手==。

数据传送的简要过程：当TCP连接建立后，两个应用进程就可以传输数据了，应用进程将要发送的数据通过socket传递给TCP，TCP将数据引导到该连接的==发送缓存==，发送缓存大小是在三次握手的过程中确定的，之后TCP将时不时从该缓存中拿出数据并传递给网络层。TCP每次可以从缓存中取出并放入报文段中的最大数据长度称为==MSS(最大报文段长度，Maximum Segment Size)==。一般来说，MSS加上TCP/IP首部的长度要小于等于链路的==MTU（最大传输单元，即最大链路层帧长度，Maximum Transmission Unit）==。以太网和PPP的MTU都等于1500字节，TCP/IP的首部通常为40字节，所以MSS一般来说为1460字节。注意==MSS是指在报文段里应用层数据的最大长度，而不是指包括首部的TCP报文段的最大长度==。TCP为每块客户数据加上TCP首部后就形成了一个个TCP报文段，这些TCP报文段被交给网络层，封装后被发送到网络中，当TCP在接收端收到一个报文段后，该报文段的数据就被放入该TCP连接的==接收缓存==中，应用程序从此缓存中读取数据流，注意到==TCP连接的每一端都有各自的发送缓存和接收缓存==。

简而言之，TCP连接的组成包括：两台主机上各自的缓存、变量和与进程连接的套接字。所以在这两台主机之间的网络元素(路由器、交换机和中继器)中，没有为该连接分配任何缓存和变量。

注意：UDP可以单播，多播，广播，而TCP只能单播传输。

### 3.4.2 TCP报文段结构

![](/zzimages/20230521162807.png)

==4比特的首部长度字段==：指示了==以32比特的字为单位==的TCP首部长度，注意一般若没有选项字段，则TCP首部长度为20字节，即首部长度为5个字。由此可见TCP首部最短是20字节，最长是60字节，且首部长度一定是4字节的整数倍。

选项字段：该字段用于发送方与接收方协商最大报文段长度MSS时，或在高速网络环境下用作窗口调节因子时使用。最多为40字节。

==6比特的标志字段==：
- CWR和ECE用于明确拥塞通告
- URG为1表示紧急数据指针字段有效，从而表明包中有需要紧急处理的数据。紧急数据指针只有在URG=1时才有效，紧急数据指针是指出了紧急数据的末尾在报文段中的位置，即从数据部分的首位到紧急数据指针所指的位置为止是紧急数据。
- ACK=1表示确认号字段中的值是有效的，TCP规定除了最初建立连接时的SYN包之外该位必须设为1
- PSH=1表示接收方应立即将数据交给上层(而不再等到整个缓存填满后才向上交付)
- RST=1表示TCP连接出现异常必须强制断开连接
- SYN用于建立连接，该位设为1，表示希望建立连接，并在其序列号的字段进行序列号初值设定
- FIN=1表示今后不再有数据发送，希望断开连接

接收窗口：指发送本报文段的一方的接收窗口(而不是自己的发送窗口)。若窗口为 0，则表示可以发送窗口探测，以了解最新的窗口大小，但这个数据必须是 1 个字节。

校验和：与UDP类似，==校验首部和数据==，只不过计算校验时添加的伪首部的第4个字段为6，而不是17

序号和确认号：TCP将数据看作是一个无结构、有序的字节流，所以==一个报文段的序号是该报文段数据字段首字节的字节流编号==，例如MSS为1000字节，如果第一个报文段的序号为0，那么第二个报文段的序列号为1000。一条TCP连接可以采取任意数字作为初始序号，这样可以减少将那些残存在网络中的报文段误认为是新建连接的报文段（新旧连接恰巧采用了相同端口）。关于确认号，==主机B填充进报文段的确认号是主机B期望从主机A收到的下一字节的序号==。因为TCP只确认该流中至第一个丢失字节为止的字节，所以TCP被称为提供==累积确认==。

例：Telnet是一个用于远程登录的流行应用层协议，它对客户到服务器的数据的确认装载在一个承载服务器到客户的数据的TCP报文段中，这种确认被称为是被捎带在服务器到客户的数据报文段中的。

### 3.4.3 往返时间的估计与超时

TCP使用超时重传机制来处理报文段丢失的问题，为此，TCP使用一种样本RTT(SampleRTT)的方法来估计RTT。SampleRTT就是从某报文段发出到收到对该报文段的确认之间的时间量，大多数TCP的实现是在某个时刻做一次SampleRTT测量。TCP并不为已经重发的报文段做SampleRTT测试，它只为传输一次的报文段测量SampleRTT。

一旦获得一个新SampleRTT，TCP一般通过
$$
EstimatedRTT=(1-a)EstimatedRTT+a\times SampleRTT
$$
来计算SampleRTT的均值。$a$一般取$\frac{1}{8}$, 因为EstimatedRTT表示最近的网络状况，所以其理应得到较大的权值。这种方法也被称为指数加权移动平均。

除了估计RTT外，测量RTT的变化也是有价值的，定义RTT偏差为DevRTT，它的计算公式如下：
$$
DevRTT =(1-b)DevRTT+b\times |SampleRTT-EstimatedRTT|,
$$
其中b的推荐值为0.25。它用于估算SampleRTT一般会偏离EstimatedRTT的程度，当SampleRTT变化较大的时候，DevRTT的值较大，当SampleRTT变化较小的时候，DevRTT就较小。

TCP的重传超时间隔采用了如下计算方式：
$$
TimeoutInterval=EstimatedRTT+4\times DevRTT.
$$
推荐的初始TimeoutInterval值为1秒。==当出现超时后，TimeOutInteval值将加倍==，以免即将被确认的后继报文段过早出现超时，==然而只要收到报文段并更新EstimatedRTT，就使用上述公式再次计算TimeoutInteval==。

### 3.4.4 可靠数据传输

TCP协议在IP协议之上，提供可靠数据传输，从而保证一个进程从其相关联的缓存中读取的数据和另一端进程发送的数据是一致的。TCP使用超时重传和冗余确认技术来处理超时、丢失等情况；使用确认、序号等技术来保证按序到达；使用校验和来检验是否报文段在传输过程中是否发生了错误。TCP发送方有3个与发送和重传有关的重要事件：从上层应用程序接收数据；定时器超时；收到ACK。
- 一旦TCP从上层应用程序接收数据，它就将数据封装在一个报文段中并交给IP，如果定时器还没有为某些其他报文段而运行，则TCP启动该定时器。
- 一旦超时，TCP就重传序号最小的已发送但未被确认的报文段，然后TCP重启定时器，并设置加倍的超时间隔。
- 一旦收到ACK，发送方更新窗口中尚未确认的序号，如果当前还有未被确认的报文段，TCP就重新启动定时器。

注意TCP实现可靠数据传输中的一些细节：

#### 几种特殊情况

![](/zzimages/20230521164048.png)

![](/zzimages/20230521164055.png)

#### 超时间隔加倍

TCP在实现上仅使用了单一的重传定时器，而并不是为每个报文段都关联一个定时器。并且当发生超时事件时，TCP就重传序号最小的已发送但未被确认的报文段，然后TCP重启定时器，并设置超时间隔为先前值的两倍。然而，每当定时器在另两个事件（收到ACK和接收到上层应用数据）启动时，新的超时间隔TimeoutInterval将由最近的EstimatedRTT与DevRTT代入公式得到。

#### 快速重传

超时触发重传存在的问题之一是超时周期可能相对较长，所以一种可行的方法是对冗余ACK的的检测(冗余ACK就是再次确认某个报文段的ACK，而发送方先前已经收到对该报文段的确认)。如果发送方收到冗余ACK，说明有多个报文段到达了接收端，但不是接收端所期望的，这意味着很有可能发生了丢失，因此TCP规定，一旦收到3个冗余ACK(即一共收到4个ACK，一个初始ACK和3个冗余ACK)，就执行快速重传，即在定时器超时之前就重传丢失的报文段。其他一些TCP产生ACK的规则如下：

![](/zzimages/20230521164207.png)

#### 选择确认

TCP采用累计确认的机制，即如果接收方正确接收了某一失序到达的分组，那么接收方发送的ACK将是对最后接收的按序到达的分组的确认，而不是对刚刚接收的分组的确认。但正确收到的失序报文将被缓存起来而不是丢弃，且丢包重传时TCP也只重传一个报文段，与GBN完全不同。因此TCP的差错恢复机制可以认为是GBN协议与SR协议的混合体。

TCP还有一种==选择确认(SACK)==的选项，它允许TCP接收方有选择地确认失序报文段，而不是累积地确认最后一个正确接收的有序报文段。当该机制与选择重传机制结合起来使用时(即跳过重传那些已被接收方选择性地确认过的报文段)，TCP就和SR协议非常相似。

### 3.4.5 流量控制

TCP为它的应用程序提供了==流量控制服务==以消除发送方使接收方缓存溢出的可能性。在TCP首部中有一个==接收窗口==字段，接收方用于告诉发送方自己还有多少可用的缓存空间，由于TCP是全双工通信，==在连接两端的发送方都各自维护一个接收窗口==。在主机B上定义变量LastByteRead(主机B上的应用进程从缓存读出的数据流的最后一个字节的编号)、LastByteRcvd(从网络中到达的并且已放入主机B接收缓存中的数据流的最后一个字节编号)，设主机B的接收缓存大小为RcvBuffer，则显然有$LastByteRcvd-LastByteRead\leq RcvBuffer$，因此此时接收窗口大小应为
$$rwnd=RcvBuffer-[LastByteRcvd-LastByteRead].$$主机B通过把当前的rwnd值放入它发给主机A的报文段接收窗口字段中，通知主机A它在该连接的缓存中还有多少可用空间。而主机A只需要保证$LastByteSent-LastByteAcked\leq rwnd$就不会使主机B的接收缓存溢出，其中左式的意义是主机A发送到连接中但未被确认的数据量(事实上，发送方的发送窗口等于$min\{自身拥塞窗口，接收方的接收窗口\}$)。

如果rwnd=0，注意到接收方在没有ACK或者数据要向发送端发送的时候，是不会通知发送方其窗口大小已经改变，即如果应用程序读取了缓存中的数据，发送方是不会知道的。所以当接收到窗口大小为0的报文段后，发送方会启动一个持续计时器，当持续计时器超时后会向接收方发送只有一个字节数据的零窗口探测报文段(如果接收方窗口仍为0，则重复上述过程，即发送方重启持续计时器；而如果接收窗口不为0，就可以通知发送方发送数据了)。

注意UDP并不提供流量控制，所以报文段由于缓存溢出可能在接收方丢失。

### 3.4.6 TCP连接管理

#### TCP连接的建立：三次握手

1. (起初客户端和服务器都是==CLOSED==状态，通信开始前双方创建传输控制块TCB，此时服务器进入==LISTEN==状态。)客户端的TCP首先向服务器端的TCP发送一个==连接请求报文段==(也称为==SYN报文段==，其中不包含应用层数据，首部标志位==SYN置为1==)。另外，客户会随机地选择一个初始序号==seq=client_isn，并将此编号放置于该报文段的序号字段中==。该报文段会被封装在一个IP数据报中，并发送给服务器。客户端的TCP状态变为==SYN_SENT==。
2. 服务器的TCP收到连接请求报文段后，如同意建立连接，则为该TCP连接分配缓存和变量，并向该客户TCP发送==允许连接的报文段(也称为SYNACK报文段)==。该报文段也不包含应用层数据，但在==首部SYN置为1，ACK置为1，确认号字段ack=client_isn+1，并且服务器选择自己的初始序号seq=server_isn并放入序号字段中==。服务器端进入==SYN_RCVD==状态。
3. 在客户收到SYNACK报文段后，客户也要给该连接分配缓存和变量，并向服务器发送另外一个确认报文段，==将SYN置为0，ACK置为1，确认号字段ack=server_isn+1，序号字段seq=client_isn+1==，除此之外，可以在该报文段负载中携带客户到服务器的数据(如果该报文段不携带数据，则不会消耗序号)。客户端进入==ESTABLISHED==状态，服务器端接收到该报文段后也进入==ESTABLISHED==状态。

一旦完成三次握手，客户和服务器主机就可以相互发送包括数据的报文段了，以后的每一个报文段中的SYN比特都被置为0，ACK比特都被置为1。注意建立连接不能只采用两次握手，因为三次握手才能防止失效的连接请求报文段被服务端接收而产生错误(失效的连接请求：若客户端向服务端发送的连接请求丢失，客户端等待应答超时后就会再次发送连接请求，此时上一个连接请求就是失效的)，若建立连接只需两次握手，如果网络拥塞，客户端发送的连接请求迟迟到不了服务端，客户端便超时重发请求，如果服务端正确接收并确认应答，双方便开始通信，通信结束后释放连接，此时如果那个失效的连接请求抵达了服务端，由于只有两次握手，服务端收到请求就会进入ESTABLISHED状态，等待发送数据或主动发送数据，但此时的客户端早已进入CLOSED状态，服务端将会一直等待下去，这样浪费服务端连接资源。

![](/zzimages/20230521165313.png)

#### TCP连接的拆除：四次挥手

1. (参与一条TCP连接的两个进程中的任何一个都能终止该连接。)假设A发出一个关闭连接命令，A就停止发送数据，向B发送一个==连接释放报文段==。该报文段只有首部，==FIN=1==(表示该报文段是一个连接释放请求)，==seq=u==(u-1是A向B发送的最后一个字节的序号)。此时，A将进入==FIN_WAIT_1==状态。(注意TCP是全双工的，可以想象为一条TCP连接上有两条数据通路，A关闭了其中一条数据通路，不能发送数据，但B还可以向A发送数据)
2. B收到连接释放报文段后，B进入==CLOSE_WAIT==状态，并向A发送连接释放的应答，其报文首部包含ACK=1，seq=v(v-1是之前B向A发送过的数据的最后一个字节的序号)，ack=u+1。A收到该应答，进入==FIN_WAIT_2==状态，等待B发送连接释放请求。第二次挥手完成后，A到B方向的连接已经释放，B不会再接收数据，A也不会再发送数据。但B到A方向的连接仍然存在，B可以继续向A发送数据，此时称为半关闭状态。
3. 当B向A发完所有数据后，向A发送连接释放请求，首部：FIN=1，ACK=1，seq=w，==ack=u+1==。B便进入==LAST_ACK==状态。
4. A收到释放请求后，向B发送确认应答，确认报文段中ACK=1，ack=w+1，seq=u+1。此时A进入==TIME_WAIT==状态，此时TCP连接还未释放，该状态会持续2MSL(最长报文段寿命)时间，若该时间段内没有B的重发请求的话，A就进入==CLOSED==状态，撤销TCB。当B收到确认应答后，也便进入==CLOSED==状态，撤销TCB。

注意A要先进入TIME_WAIT状态，等待时间后(约30秒)才进入CLOSED状态，这是为了保证B能收到A的确认应答，若A发完确认应答后直接进入CLOSED状态，那么如果该应答丢失，B等待超时后就会重新发送==FIN连接释放请求==，但此时A已经关闭了，不会作出任何响应，因此B永远无法正常关闭。而只有A先进入TIME_WAIT状态后，一旦B没有收到A的ACK应答，B就重传FIN连接释放请求，直到它收到A的最终ACK应答。

![](/zzimages/20230521165630.png)

注意假如一台主机接收了具有目的端口80的一个TCP SYN分组，但该主机在端口80不接收连接，则该主机将向源发送一个特殊重置报文段，该TCP报文段将RST标志位置为1。如果一台主机接收一个UDP分组，而它的目的端口与进行中的UDP套接字不匹配，则该主机发送一个特殊的ICMP数据报。

这种TCP连接管理协议容易遭受SYN洪泛攻击，即攻击者发送大量TCP SYN报文段，却不完成第三次握手的步骤。为此采用了一种有效的防御系统：SYN cookie，当收到一个SYN报文段后，服务器根据源和目的IP地址与端口号，结合该服务器的一个秘密的散列函数，得到一个初始序列号，称为cookie，关键的是，服务器不会记忆该cookie或任何对应于SYN的其他状态信息，任何发送具有这种特殊初始序列号的SYNACK分组。如果客户是合法的，它收到SYNACK分组后会返回一个ACK报文段，于是该服务器根据该报文段中的IP地址和端口号运用同样的散列函数进行计算，如果结果加1正好等于该报文段中的ack，则服务器认为该ACK对应于较早的SYN报文段，因此它是合法的，于是服务器生成一个具有套接字的全开的连接。反之，如果非法的客户没有返回一个ACK报文段，则初始的SYN并没有对服务器产生危害，因为服务器没有为它分配任何资源。

## 3.5 拥塞控制原理

### 3.5.1 拥塞原因与代价

计算机网络拥塞的原因是因为网络中的分组太多，而链路带宽和路由器缓存容量都是有限的。拥塞导致的代价如下：
- 当分组的到达速率接近链路容量时，分组将经历巨大的排队时延。
- 发送方必须执行重传以补偿因为缓存溢出而丢弃的分组。
- 发送方遇到大时延时所进行的不必要重传会引起路由器利用其链路带宽来转发不必要的分组副本。
- 当一个分组沿着一条路径被丢弃时，每个上游路由器用于转发该分组到丢弃该分组而使用的传输容量最终被浪费掉了。

### 3.5.2 拥塞控制方法

总体来说，我们可以根据网络层是否为运输层拥塞控制提供了显式帮助来区分拥塞控制方法：==端到端拥塞控制和网络辅助的拥塞控制==。

在端到端拥塞控制方法中，网络层并没有向运输层拥塞控制提供显式支持。即便网络中存在拥塞，端系统也必须通过对网络行为的观察（如分组丢失与时延）来判断。TCP必须通过端到端的方法解决拥塞控制，因为IP层不会向端系统提供有关网络拥塞的反馈信息。TCP报文段的丢失（通过超时或者收到3次冗余确认而得知）被认为是网络拥塞的一个迹象，TCP将相应地减小窗口长度。除此之外TCP拥塞控制还有些最新建议，即使用增加的往返时延值作为网络拥塞程度增加的指示。

在网络辅助的拥塞控制方法中，路由器向发送方提供关于网络中拥塞状态的显式反馈消息，比如使用一个比特位来指示网络是否拥塞。拥塞信息从网络反馈到发送方一般有两种方式，其中直接反馈信息可以由网络路由器发给发送方，这种方式的通知通常采用了一种拥塞分组的形式；第二种形式的通知更为通用，是路由器标记或者更新从发送方到接收方的分组中的某个字段来指示拥塞的产生，然后由接收方向发送方通知该网络发生了拥塞。

注意拥塞控制与流量控制的区别：拥塞控制是作用于网络的，它是防止过多的数据注入到网络中，避免出现网络负载过大的情况；流量控制是作用于接收者的，它是控制发送者的发送速度从而使接收者来得及接收。

## 3.6 TCP拥塞控制

TCP必须使用端到端的拥塞控制，因为IP并不会向端系统提供显式的网络拥塞反馈。TCP所采用的方法是让每一个发送方根据其所感知的网络拥塞程度来限制其能向连接发送流量的速率。运行在发送方的TCP跟踪一个额外的变量，即拥塞窗口cwnd，它对发送方能向网络中发送流量的速率进行了限制。所以要求发送方中已发送但未被确认的数据量不超过$\min\{cwnd,rwnd\}.$

假设发送方可以在RTT时间范围内连续发送cwnd个字节的数据(以下均不考虑rwnd)，所以发送速率即为cwnd/RTT，因此发送方可以通过调整拥塞窗口大小来对发送数据的速率加以控制。TCP使用以下原则来控制发送数据的速率：
- 一个丢失的报文段意味着拥塞，因此当丢失报文段时应当降低TCP发送方的速率；
- 一个确认报文段指示该网络正在向接收方交付发送方的报文段，因此，当收到对先前报文段的确认时，可以增加发送方的速率。因为TCP使用ACK对拥塞窗口做出调节，所以TCP也称为自计时的。
- 带宽探测。TCP调节其传输速率的策略是增加速率以响应到达的ACK，除非出现丢包，此时才减少发送速率。因为网络中没有明确的拥塞控制状态信令，所以ACK和丢包事件充当了隐式信号。

以上为TCP拥塞控制的概述，接下来就是广受赞誉的TCP拥塞控制算法，该算法包含三个主要部分：慢启动、拥塞避免、快速恢复。慢启动和拥塞控制是TCP的强制部分，两者的差异在于对收到的ACK做出反应时增加cwnd长度的方式；快速恢复是推荐部分，对于TCP发送方并非是必须的。

### 慢启动

TCP连接在开始的时候，其cwnd通常设置为一个MSS，然后在慢启动状态每当收到已传输的报文段的首次确认，cwnd就增加一个MSS。因此在慢启动阶段，cwnd是指数增加的（1,2,4,8…），所以发送速率起始慢，但之后指数增长(==每经过一个RTT，cwnd就会加倍==，注意在慢启动阶段下，cwnd不能超过ssthresh，如果经过一个RTT后，2\*cwnd超过了ssthresh，则此时新的cwnd的值应为ssthresh，然后进入拥塞避免模式)。有三种情况会结束这种指数增长：发生了超时、收到3个冗余ACK以及cwnd达到ssthresh(ssthresh是==慢启动阈值==)。在慢启动阶段，如果发生了超时事件，那么就令ssthresh的值为当前cwnd的一半，然后将cwnd置为1个MSS；如果收到3个冗余ACK，那么TCP会做一次快速重传，然后进入快速恢复阶段；当cwnd逐步增加到ssthresh时，TCP结束慢启动，进入拥塞避免模式。

### 拥塞避免

一旦进入拥塞避免状态，TCP每经过一个往返时延RTT，只将cwnd增加一个1个MSS大小，也就是说在拥塞避免阶段，cwnd是线性增加的。结束线性增长的情况有以下两种：当出现超时时，将ssthresh更新为cwnd的一半，然后将cwnd设置为1个MSS，回到慢启动阶段；当收到3个冗余ACK时，TCP会做一次快速重传，然后进入快速恢复阶段。

### 快速恢复

在快速恢复阶段，首先将ssthresh置为cwnd值的一半，然后将cwnd的值先减半再加上冗余ACK的数量(例如收到3个冗余ACK引起TCP进入快速恢复阶段，则此时cwnd的值为cwnd/2+3，单位是MSS)，然后进入拥塞避免状态。

![](/zzimages/20230521190249.png)

注意如果TCP不采用快速恢复的方法，那么收到3个冗余ACK的处理与超时处理相同。如上图所示，Tahoe就不采用快速恢复，而Reno采用了快速恢复。(这两种TCP版本在前8个RTT的cwnd相同，假设在第8个RTT发生了收到3个冗余ACK的事件，则第9回合开始他们的cwnd不再相同)。根据以上特性，TCP拥塞控制常常被称为==加性增、乘性减==拥塞控制方式。

注意现今的TCP拥塞控制还会使用网络辅助的拥塞控制，称为明确拥塞通告，它利用了TCP首部中CWR和ECE两个标志。

# 第4章 网络层：数据平面

## 4.1 网络层概述

### 4.1.1 转发和路由选择：数据平面和控制平面

网络层的作用是将分组从一台发送主机移动到另一台接收主机。每台路由器的数据平面的主要作用是从其输入链路向其输出链路转发数据报；控制平面的主要作用是协调这些本地的路由器转发动作，使得数据报沿着源和目的地主机之间的路由器路径最终进行端到端传送。路由器主要完成两个功能：
- ==转发==：是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。转发发生的时间尺度很短，因此通常用硬件来实现。转发是在数据平面中实现的唯一功能。
- ==路由选择==：是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程。路由选择发生的时间尺度很长，因此通常用软件来实现。路由选择在控制平面中实现。

每台路由器都有一张转发表(路由表)，路由器检查分组首部字段值，使用该值在转发表索引查询，该值对应存储在转发表项中的值指出了该分组将被转发的路由器输出链路接口，通过这种方法来转发分组。实现路由选择功能的方法有两种：传统的方法是每台路由器都有一个与其他路由器的路由选择组件通信的路由选择组件，通过路由选择算法来决定插入该路由器转发表的内容；另一种方法是SDN方法，控制平面路由选择功能与物理的路由器是分离的，即路由选择设备仅执行转发，而远程控制器计算并分发转发表，路由器和远程控制器通过交换包含转发表和其他路由选择信息的报文来进行通信，这就是软件定义网络(SDN, Software-Defined Networking)的本质。

一些基本术语：转发和交换这两个术语含义是相同的；分组交换机是指一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组；链路层交换机基于链路层帧中的字段值做出转发决定，而路由器基于网络层数据报中的首部字段值做出转发决定。

计算机网络用一些中间设备相互连接，以构成更大的网络系统：
- 物理层中继系统：转发器(中继器)，集线器
- 链路层中继系统：网桥，交换机
- 网络层中继系统：路由器(网关)

### 4.1.2 网络服务模型

网络服务模型定义了分组在发送与接收端系统之间的端到端运输特性。网络层可以提供的服务如下(注意IP并不提供以下服务)：
- 确保交付：确保分组将最终到达目的地
- 具有时延上界的确保交付
- 有序分组交付
- 确保最小带宽
- 安全性

然而因特网的网络层IP协议只提供尽力而为服务，传送的分组既不能保证以它们发送的顺序被接收，也不能保证它们最终交付，既不能保证端到端时延，也不能保证有最小的带宽。

## 4.2 路由器工作原理

![](/zzimages/20230521202222.png)

- 输入端口：最左边的方框执行将一条输入的物理链路与路由器相连接的物理层功能；中间的方框执行与位于入链路远端的数据链路层交互的数据链路层功能；右边的方框执行查找功能，查询转发表决定路由器的输出端口，将分组转发到输出端口。注意这里的端口指的是路由器的物理输入和输出接口，并不是指应用程序和套接字相关联的软件端口。
- 交换结构：将路由器的输入端口与输出端口相连，分组通过交换结构转发到输出端口。
- 输出端口：存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。当链路是双向的时，输出端口与输入端口成对出现在同一线路卡上。
- 路由选择处理器：执行控制平面功能。在传统的路由器中，它执行路由选择协议，维护路由选择表与关联链路状态信息，为路由器计算转发表。在SDN路由器中，路由选择处理器负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项。路由选择处理器还执行网络管理功能。

### 4.2.1 输入端口处理和基于目的地转发

![](/zzimages/20230521202339.png)

查找功能要对大型转发表使用快速查找算法，转发表从路由选择处理器经过独立总线复制到输入线路卡（影子副本），有了转发表副本，转发决策能在每个输入端口本地做出，无须调动路由选择处理器，避免集中式处理。路由器用分组目的地址的前缀与转发表中的表项进行匹配，如果存在多个匹配，则使用最长前缀匹配规则，即在该表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组。查找确定了某分组输出端口，分组就能发送进入交换结构，而一个被阻塞的分组必须在输入端口处排队。尽管查找在输入端口处理中可认为是最重要的动作，但必须采取其他动作：
- 必须出现物理层和数据链路层处理
- 必须检验分组的版本号、检验和和寿命字段，后两个字段必须重写
- 必须更新用于网络管理的计数器

### 4.2.2 交换结构

![](/zzimages/20230521202445.png)

通过交换结构，分组才能实际地从一个输入端口转发到一个输出端口中。有以下三种交换方式：
- 经内存交换：最简单、最早的路由器是传统的计算机
- 经总线交换：输入端口经一根共享总线将分组直接传送到输出端口，不需要路由选择处理器的干预
- 经互联网络交换：纵横式网络能够并行转发多个分组，因此它是非阻塞的。除非来自两个不同输入端口的两个分组其目的地为相同的输出端口，则一个分组必须在输入端等待。

### 4.2.3 输出端口处理

![](/zzimages/20230521202539.png)

### 4.2.4 排队

输入、输出端口都能形成分组队列，取决于流量负载、交换结构，随着队列增长，路由器缓存空间会耗尽，出现丢包。

输入端口排队会出现线路前部阻塞现象，即一个分组被位于线路前部的另一个分组所阻塞。

输出端口采用分组调度程序在这些排队分组中选择一个分组来传输。分组调度有以下算法：
- 先进先出
- 优先权排队：将分组放入相应优先权类的队列中，在最高优先权类队列中传输一个分组，同一优先权类的分组间采用FIFO。非抢占式规则下，一旦分组开始传输就不能打断。
- 循环和加权公平排队：循环排队规则是在每个类队列中轮流的提供服务；加权公平排队规则是每个类分配一个权重，然后类似循环排队规则，但每个类收到的服务时间不超过该权重，然而这种方法会破坏非抢占式规则。

## 4.3 IPv4

### 4.3.1 IPv4数据报格式

![](/zzimages/20230521202725.png)

- 版本号：4bit，规定了数据报的IP协议版本，该字段值为4
- 首部长度：4bit，以4字节为单位，首部最短长度为20字节，最长为60字节
- 服务类型：服务类型(TOS)用于区分不同类型的IP数据报，一般不使用，取值为0
- 数据报长度：IP数据报总长度(首部加数据)，以字节为单位
- 标识、标志、片偏移：与IPv4分片相关
- 寿命：寿命(Time-To-Live, TTL)确保数据报不会永远在网络中循环。每被一个路由器处理时，值-1，若值减到0，丢弃数据报
- 协议：到达最终目的地才有用，指示了IP数据报的数据部分应该交给哪个运输层协议。如6交给TCP，17交给UDP，除此之外还有ICMP(1), IGMP(2), IPv6(41)。协议号是将网络层与运输层绑定到一起的粘合剂，端口号是将运输层和应用层绑定的粘合剂。
- 首部检验和：帮助路由器检测收到IP数据报中首部的比特错误，有错一般丢弃。每台路由器上必须重新计算检验和，因为TTL以及可能的选项字段会改变。==注意IP层仅对IP首部计算检验和，而TCP/UDP检验和是对整个TCP/UDP报文段进行的==。
- 源和目的IP地址：源主机通过DNS查找目的IP地址
- 选项：允许IPv4首部被扩展，最多40字节
- 数据（有效载荷）：包含运输层报文段（TCP或UDP），或ICMP报文段

### 4.3.2 IPv4数据报分片

==一个链路层帧能承载的最大数据量(帧的数据部分)叫作最大传送单元(MTU, Maximum Transmission Unit)==。大IP分组向较小MTU链路转发时需要分片 (fragmented)，将IP数据报中的数据分片成多个较小的IP数据报，用单独的链路层帧封装这些IP数据报。片的重新组装在接收端系统中完成。IP首部的相关字段用于标识分片以及确定分片的相对顺序：当生成一个数据报时，发送主机为该数据报设置源和目的地址的同时贴上标识号，发送主机通常将它发送的每个数据报的标识号加1；当某路由器需要对一个数据报分片时，==形成的每个片具有初始数据报的源地址、目的地址和标识号==；当目的地从同一发送主机收到一些列数据报时，它能够检查数据报的标识号以确定哪些数据报实际上是同一较大数据报的片；另外，为了让目的主机确定是否丢失了一个片，使用偏移字段，即数据部分的偏移(以8个字节为单位，所以除了最后一片，每个分片的数据部分长度一定是8B的整数倍)指定该片应放在初始IP数据报的哪个位置。注意标志位有3位，最低位为MF，MF=1表示后面还有分片，MF=0表示最后一个分片，中间一位是DF，只有当DF=0时才允许分片。

### 4.3.3 IPv4编址

在全球因特网中的每台主机和路由器上的每个接口，都必须有一个全球唯一的IP地址(在NAT后面的接口除外)，即IP协议为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。IPv4地址一般用点分十进制记法书写。这些地址不能随意地自由选择，一个接口的IP地址的一部分需要由其连接的子网来决定。

![](/zzimages/20230521203126.png)

为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点，这些隔离的网络中的每一个都叫做一个子网。如上图就有6个子网(路由器与路由器之间的也算)，例如互联2个主机接口与1个路由器接口的子网223.1.1.0/24，其中的/24记法称为子网掩码，指示左侧的24比特定义了子网地址。一个具有多个以太网段和点对点链路的组织(如一个公司或学术机构)将具有多个子网，在给定子网上的所有设备都具有相同的子网地址。因特网的地址分配策略称为==无类别域间路由选择(CIDR==, Classless Interdomain Routing)，即将IP地址划分为两部分，形式为a.b.c.d/x的地址的x最高比特构成了IP地址的网络部分(网络前缀)，一个组织通常被分配具有相同网络前缀的一段地址，而剩余32-x比特可认为是用于区分该组织内部设备的，当然该组织仍可以划分子网，例如可以用32-x中的3位划分8个子网，于是每个子网的网络前缀就变成了x+3位。将网络前缀都相同的连续IP地址组成CIDR地址块，一个CIDR地址块可以表示很多地址，这种地址的聚合称为路由聚合，或称为构成超网，它有利于减少路由器之间的信息交换，提高网络性能。

![](/zzimages/20230521203254.png)

在CIDR被采用之前，IP地址的网络部分被限制为长度为8、16、24比特，这是一种被称为==分类编址==的编址方案(现今已不再使用)：

![](/zzimages/20230521203321.png)
- 主机号全0表示本网络本身，如202.98.174.0(对于CIDR也成立，主机号全0表示本子网本身)
- 主机号全1表示本网络的广播地址，如202.98.174.255(对CIDR也成立，主机号全1表示本子网的广播地址)
- 127.x.x.x保留为环回自检地址，此地址表示任意主机本身，目的地址为环回地址的IP数据报永远不会出现在任何网络上
- 32位全0表示本网络上的本主机
- 32位全1表示整个TCP/IP网络的广播地址，实际使用时，由于路由器对广播域的隔离，它等效于本网络的广播地址

![](/zzimages/20230521203420.png)

注意，用转发器或网桥连接的若干局域网仍然是同一网络(同一广播域)，因此该局域网中所有主机的IP地址的网络号都相同。路由器的每个端口都有一个不同网络号的IP地址，所以路由器至少有两个IP地址。

#### 获取地址

获取一块地址：子网想获取一块IP地址时，由其ISP从已分给它的更大地址块中提供一些地址；ISP向获取IP地址时，由因特网名字和编号分配机构ICANN管理IP地址的分配。

获取主机地址：系统管理员通常手工配置路由器中的IP地址。主机地址也能手动配置，但更多的是使用==动态主机配置协议(DHCP==, Dynamic Host Configuration)，DHCP允许主机自动获取一个IP地址，DHCP是应用层协议，它是基于UDP的。网络管理员能够配置DHCP，以使某给定主机每次与网络连接时能得到一个相同的IP地址，或者某主机将被分配一个临时的IP地址，每次与网络连接时该地址也许是不同的。除此之外，DHCP还允许一台主机查看子网掩码、默认网关（第一跳路由器地址）、本地DNS服务器地址等信息。由于DHCP具有将主机连接进一个网络的自动能力，所以常被称为即插即用协议或零配置协议。DHCP是一个客户-服务器协议，客户通常是新到达的主机，它要获得包括自身使用的IP地址在内的网络配置信息。一般每个子网都有一台DHCP服务器，若子网没有DHCP服务器，则由一个路由器做DHCP中继代理，该代理知道该网络的DHCP服务器地址。新主机到来时，DHCP协议的四个步骤如下：
1. DHCP服务器发现：新到的客户通过广播==DHCP发现报文==，发现一个要与其交互的DHCP服务器，客户在UDP分组中向端口67发送该发现报文，此时必须用广播地址255.255.255.255，源地址是0.0.0.0
2. DHCP服务器提供：DHCP收到DHCP发现报文后，响应一个==DHCP提供报文==，仍然使用广播地址，因为此时新客户并没有IP地址。可能有多台DHCP服务器，每台服务器提供的报文中，有向客户主机推荐的IP地址、网络掩码以及IP地址租用期（一般几天或几小时）
3. DHCP请求：客户从多个服务器提供中选一个，向选中的服务器提供用一个==DHCP请求报文==进行响应，回显配置的参数。源地址仍为0.0.0.0，目的地址仍为广播地址255.255.255.255
4. DHCP ACK：收到DHCP请求报文后，服务器广播==DHCP ACK报文==对其进行响应，证实所传参数。

客户收到ACK后，交互完成，在租期内使用DHCP分配的IP地址。DHCP提供了机制允许客户更新对一个IP地址的租用。

### 4.3.4 网络地址转换(NAT, Network Address Translation)

地址10.0.0.0/8是保留的3个IP地址空间之一(A类：==10==.0.0.0~==10==.255.255.255；B类：==172.16==.0.0~==172.31==.255.255；C类：==192.168.0==.0~==192.168.255==.255)，这些地址用于家庭网络等专用网络或具有专用地址的地域(具有专用地址的地域是指其地址仅对该网络中的设备有意义的网络)，即私有IP地址。在一个给定家庭网络中的设备能够使用10.0.0.0/24编址彼此发送分组，然而转发到家庭网络之外进入更大的全球因特网的分组显然不能使用这些地址，因为有数十万的网络使用着这块地址。所以需要NAT，NAT路由器对外界来看像一个具有单一IP地址的单一设备，它对外界隐藏了家庭网络的细节。例如，家里有一个NAT使能路由器，其IP地址138.76.29.7，技巧就是使用NAT路由器上的一张NAT转换表，并在表项中包含了端口号及其IP地址。

![](/zzimages/20230521204003.png)

端口号和IP地址用于路由器将分组转发给特定的内部主机，例如主机10.0.0.1的3345端口要请求一个Web页面，NAT路由器收到该数据报，并为该数据报生成一个新源端口号5001，将源IP地址替代为138.76.29.7，在NAT转换表中增加该表项，然后与外界通信。

如果两个不同NAT路由器内部的主机想要通信，一台主机可以先向自己的NAT路由器发送一个虚拟网络包从而生成NAT转换表，从而就能使两个不同NAT路由器内部主机之间也能通信，这种现象叫NAT穿越。

## 4.4 IPv6

### 4.4.1 IPv6数据报格式

![](/zzimages/20230521204106.png)

- 版本：4bit，规定了数据报的IP协议版本，该字段值为6
- 流量类型：8bit，与IPv4中的TOS字段含义类似
- 流标签：20bit，用于标识一条数据报的流
- 有效载荷长度：16bit，数据部分的长度，单位字节
- 下一个首部：该字段标识数据报中的内容需要交付给哪个协议(如TCP或UDP)，与IPv4首部中的协议字段相同
- 跳限制：与寿命相同
- 源和目的地址：IP地址长度为128位
- 数据（有效载荷）

注意IPv6的首部长度固定为40字节；IPv6不允许在中间路由器上进行分片与重新组装，只能在源和目的地执行；IPv6数据报的目的地址可以是单播(一对一通信)、多播(一点对多点通信)、任播(这是IPv6增加的一种类型，任播的目的站是一组计算机，但数据报在交付时只交付其中的一台计算机，任播在实际网络中的应用有DNS根域名解析服务器)。IPv6的书写方式是把地址中的每4位用一个十六进制数表示并用冒号分隔每16位，如4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170

### 4.4.2 从IPv4到IPv6的迁移

IPv6可以向后兼容IPv4，但要用IPv4的路由器来处理IPv6数据报必须使用建隧道或双协议栈的方法。借助于隧道，在隧道发送端的IPv6节点可将整个IPv6数据报放到一个IPv4数据报的数据字段中，并在IPv4数据报中的协议号字段设为41，从而指示该IPv4有效载荷是IPv6数据报。双协议栈是指在一台设备上同时装有IPv4和IPv6的协议栈。

## 4.5 SDN概述

软件定义网络(SDN)采用集中式的控制平面和分布式的数据平面，两个平面互相分离。传统互联网中，每个路由器既有转发表又有路由选择软件，即包含数据平面和控制平面，但在SDN中，路由器不再需要路由选择软件，从而路由器之间无需交换路由信息。在SDN的控制平面有一个逻辑上的远程控制器(可由多个服务器组成)，远程控制器掌握各主机和整个网络的状态，为每个分组计算出最佳路由，通过Openflow协议将转发表(SDN中称为流表)下发给路由器。于是路由器的工作简化为收到分组、查找转发表、转发分组。

SDN通过为开发者们提供强大的编程接口，使得网络具有很好的编程性。对上层应用的开发者，SDN提供的编程接口称为北向接口。SDN控制器和转发设备建立双向会话的接口称为南向接口，通过不同的南向接口协议(如Openflow)，SDN控制器就可兼容不同的硬件设备，同时可以在设备中实现上层应用的逻辑。SDN控制器集群内部控制器之间的通信接口称为东西向接口，用于增强整个控制平面的可靠性和可扩展性。

SDN的优点：
- 全局集中式控制和分布式高速转发，既利于控制平面的全局优化，又利于高性能的网络转发
- 灵活可编程与性能的平衡
- 降低成本

SDN的缺点：
- 安全风险，集中管理容易受攻击
- 瓶颈问题，随着网络规模扩大，控制器可能成为网络性能的瓶颈

## 4.6 IP数据报的发送和转发过程

### 4.6.1 冲突域和广播域

冲突域是指连接到同一物理介质上的所有结点的集合，这些结点之间存在介质争用的现象。物理层设备所连接的结点都属于同一个冲突域，也就是说物理层设备不能划分冲突域。而链路层设备、网络层设备都可以划分冲突域。

广播域是指接收同样广播消息的结点集合。物理层设备、链路层设备都不能划分广播域，而网络层设备可以划分广播域。通常所说的局域网特指使用路由器分割的网络，也就是广播域。

### 4.6.2 IP数据报的发送和转发过程

![](/zzimages/20230521204524.png)

以上判断目的主机是否与自己在同一个网络，只需将IP地址与子网掩码相与即可，从而就能判断网络号是否相同；标准的路由表有4个项目：==目的网络IP地址、子网掩码、下一跳IP地址、接口==，当IP数据报在路由表中查找匹配条目时，将目的IP地址与路由表中子网掩码相与，判断是否和路由表中目的网络IP地址相匹配，然后找到最长匹配的条目进行转发。注意如果目的地址是本网络的广播地址，则该广播域内的主机都能收到该数据报，而路由器则不会转发，因为它是隔离广播域的。路由表中还可能有默认路由(0.0.0.0/0，当其他路由都不匹配时会选择默认路由进行转发)和主机路由(IP地址/32，表示直接转发到该主机，使用主机路由可能导致路由表膨大、路由负荷增加、进而造成网络性能下降)。


# 第5章 网络层：控制平面

## 5.1 路由选择算法

### 5.1.1 分类

路由选择算法的目的是从发送方到接收方的过程中确定一条通过路由器网络的好的路径。有以下分类：
- ==集中式路由选择算法==用完整的、全局性的网络知识计算出从源到目的地之间的最低开销路径，具有全局状态信息的算法常被称作链路状态(LS, Link State)算法；==分散式路由选择算法==中路由器以迭代、分布式的方式计算出最低开销路径，如距离向量(DV, Distance-Vector)算法。
- ==静态路由选择算法==中路由随时间变化缓慢，通常是人工进行调整；==动态路由算法==随着网络流量负载或拓扑发生变化而改变路由选择路径。
- ==负载敏感算法==中，链路开销会动态地变化以反映出底层链路的当前拥塞水平；现在的算法都是==负载迟钝算法==，因为某条链路的开销不明确地反映其当前的拥塞水平。

### 5.1.2 链路状态路由选择算法

链路状态路由选择算法要求每个结点都具有完全的网络拓扑信息，它们执行以下任务：第一，主动测试所有邻接结点的状态；第二，定期地将链路状态传播给所有其他结点。一旦链路状态发生变化，结点就用收到的报文更新自己的网络图，然后采用Dijkstra最短路径算法重新计算路由。典型的链路状态算法是OSPF算法。LS算法有以下特征：
- 采用洪泛法==向本自治系统中所有路由器发送信息==，即路由器通过所有端口向所有相邻的路由器发送信息，而每个相邻的路由器又将此信息发往其所有相邻路由器(不发送给刚刚发来信息的那些路由器)
- 发送的信息只是==与该路由器相邻==的所有路由器的链路状态(标识、距离、费用等等)，而并不是该路由器知道的全部信息
- 只有==当链路状态发生变化时==，路由器才向所有路由器发送此信息。而相邻路由器间则是周期性地交换信息。

### 5.1.3 距离向量路由选择算法

DV算法中，所有结点都定期地将它们的==整个路由选择表==传送给所有==与之相邻的结点==，路由选择表中包含每条路径的目的地及该路径的代价(距离)。所有结点都监听从其他结点传来的路由选择更新信息，在下列情况下更新自己的路由选择表：
- 被告知一条新的路由，该路由在本结点的路由表中不存在，此时加入这条新的路由
- 发来的路由信息中有一条到达某个目的地的路由，该路由与当前使用的路由相比，有更小的代价，这种情况下，就用经过发送路由信息的结点的新路由替换路由表中到达那个目的地的现有路由。

最常见的DV算法是RIP算法。

## 5.2 RIP、OSPF、BGP

### 5.2.1 自治系统

自治系统(Autonomous System, AS)是指单一技术管理下的一组路由器，这些路由器使用一种AS内部的路由选择协议和共同的度量来确定分组在该AS内的路由，通常在一个ISP中的路由器以及互联它们的链路构成一个AS。一个自治系统内部使用的路由选择协议称为内部网关协议，常用的有RIP和OSPF；自治系统之间使用的路由选择协议称为外部网关协议，常用的有BGP。

### 5.2.2 路由信息协议(RIP)

路由信息协议(RIP, Routing Information Protocol)是一种分布式的基于距离向量的路由选择协议，==它是应用层协议，使用UDP传送数据==。RIP规定：
- 网络中的每个路由器都要维护从它自身到其他每个目的网络的距离记录。距离也称跳数，规定从一个路由器到直接连接网络的跳数为1。每经过一个路由器，跳数加1。
- RIP允许一条路径最多15跳，当距离等于16时表示网络不可达，这是为了避免环路的情况，可见RIP只适用于小型互联网。
- 路由选择更新信息在邻居之间==每30秒交换一次==。

每个路由表项目有三个关键数据：<目的网络N，距离d，下一跳路由器地址X>。具体的距离向量算法如下：
1. 对于==相邻路由器==X发来的RIP报文，将报文中下一跳字段都改为X，并把所有距离字段加1
2. 对修改后的RIP报文中的每个项目，执行如下步骤：
    - 如果原路由表中没有目的网络N，就把该项目添加到路由表中；
    - 如果原路由表中有目的网络N，且下一跳路由器地址就是X时，用收到的项目替换原路由表中的项目；
    - 如果原路由表中有目的网络N，且下一跳路由器地址不是X时，如果收到的项目中的距离d小于路由表中的距离，那么就用收到的项目替换原路由表中的项目；否则什么也不做。
3. 如果180秒还没有收到相邻路由器的更新路由表，就将此相邻路由器标记为不可达，即把距离设置为16

注意RIP会出现坏消息传得慢的现象，例如y到x的距离是1，z到y的距离1，于是z可通过y到x，故z到x的距离是2，此时若x出现故障导致y到x的距离是16，y和z会彼此交换信息，z先将已过时的信息(z到x距离为2)告知y，于是y相应更新y到x的距离为3(但实际并非如此，因为z原本是通过y才到x的)，然后y再将该信息告知z，于是z相应更新z到x的距离为4，然后一直重复该流程，经过很长时间后才会达到y到x的距离是16。

### 5.2.3 开放路径最短优先协议(OSPF)

OSPF是一种典型的链路状态路由选择算法，它是==运输层协议，基于IP数据报==传送数据。注意每台路由器虽然使用Dijkstra算法计算出完整的最优路径，但路由表中不会存储完整路径，而只存储下一跳路由器的地址。OSPF通常将一个自治系统再划分为若干更小的区域，于是利用洪泛法交换链路状态信息的范围局限于每个区域，从而减少了整个网络上的通信录，因此OSPF能够用于规模很大的网络。

### 5.2.4 边界网关协议(BGP)

边界网关协议(BGP, Border Gateway Protocol)是不同自治系统的路由器之间交换路由信息的协议。BGP只能力求寻找一条能够到达目的网络且比较好的路由，而并非寻找一条最佳路由，它采用的是路径向量路由选择协议。==BGP是应用层协议，基于TCP==。BGP的工作原理如下：每个自治系统的管理员要选择至少一个路由器作为该自治系统的网关路由器(位于AS边缘的路由器，它可以直接连接到在其他AS中的一台或多台路由器)，一个网关路由器与其他自治系统中的网关路由器要交换路由信息，必须先建立TCP连接，网关路由器相互交换网络可达性信息后就能找出较好的路由。网关路由器只和相邻的网关路由器交换信息，首次交换时交换整个路由表，以后则只交换有变化的部分。

## 5.3 ICMP

因特网控制报文协议(ICMP, Internet Control Message Protocol)被主机和路由器用来彼此沟通网络层的信息，其最典型的用途是差错报告。如"目的网络不可到达"这种错误是在ICMP产生的，IP路由器找不到路径通往指定主机，该路由器就向发送主机发出ICMP报文指示错误。==ICMP通常被认为是IP的一部分==，但从体系结构上来讲它是位于IP之上的，因为ICMP报文是承载在IP分组中的，也就是说，==ICMP报文是作为IP有效载荷承载的==。

![](/zzimages/20230615133516.png)

ICMP报文有两种类型：

### ICMP差错报告报文

主要有以下5种类型：
- 终点不可达(3)：当路由器或主机不能交付数据报时，就向源点发送终点不可达报文
- 源点抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢
- 时间超过：当路由器对收到的数据报TTL减一后等于0时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
- 参数问题：当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
- 改变路由(重定向)(5)：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。

以下情况不应发送ICMP差错报告报文：
- 对ICMP差错报告报文不再发送ICMP差错报告报文
- 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
- 对具有多播地址的数据报都不发送ICMP差错报告报文
- 对具有特殊地址(如127.0.0.0或0.0.0.0)的数据报不发送ICMP差错报告报文

### ICMP询问报文

主要有4种类型：回送请求和回答报文(8)、时间戳请求和回答报文、地址掩码请求和回答报文、路由器询问和通告报文。

ICMP的两个常见应用是分组网间探测PING(用来测试两台主机之间的连通性)和Traceroute(用来跟踪分组经过的路由)。PING使用了ICMP回送请求和回答报文，Traceroute使用了ICMP时间超过报文(Traceroute分别使用TTL=1，TTL=2，….的报文来测试分组经过的路由)。

## 5.4 IGMP

### 5.4.1 组播(多播)

组播是让源主机一次发送的单个分组可以抵达用一个组地址标识的若干目标主机，并被它们正确接收。组播应用于UDP。因特网中的IP组播使用组播组的概念，每个组都有一个特别分配的地址，要给该组发送数据的主机将使用这个地址作为分组的目标地址。主机使用IGMP加入组播组。注意主机组播时仅发送一份数据，只有数据在传送路径出现分岔时才将分组复制后继续转发。

### 5.4.2 IP组播地址

IP组播使用D类地址格式，每个D类IP地址标志一个组播组。IP组播数据报的首部中协议字段值是2，表明使用IGMP。注意：
- 组播数据报也是尽最大努力交付，不提供可靠交付
- 组播地址只能用于目的地址，而不能用于源地址
- 对组播数据报不产生ICMP差错报文
- 并非所有的D类地址都可作为组播地址

### 5.4.3 IGMP与组播路由算法

要使路由器知道组播组成员的信息，需要利用因特网组管理协议(IGMP, Internet Group Management Protocol)。连接到局域网上的组播路由器还必须和因特网上的其他组播路由器协同工作，以便把组播数据报用最小代价传送给所有组成员，这就需要使用组播路由算法。注意：
- IGMP并不是在因特网范围内对所有组播组成员进行管理的协议
- IGMP不知道IP组播组包含的成员数，也不知道这些成员分布在哪些网络上
- IGMP让连接到本地局域网上的组播路由器知道本局域网上是否有主机参加或退出了某个组播组

IGMP应视为网际协议IP的一个组成部分，其工作可分为两个阶段：
- 第一阶段：当某台主机加入新的组播组时，该主机应向组播组的组播地址发送一个IGMP报文，声明自己要成为该组的成员。本地的组播路由器收到IGMP报文后，将组成员关系转发给因特网上的其他组播路由器。
- 第二阶段：因为组成员关系是动态的，本地组播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否仍继续是组的成员。只要对某个组有一台主机响应，那么组播路由器就认为这个组是活跃的。但一个组在经过几次的探询后仍然没有一台主机响应时，则不再将该组的成员关系转发给其他的组播路由器。

组播路由选择实际上就是要找出以源主机为根节点的组播转发树，其中每个分组在每条链路上只传送一次(即在组播转发树上的路由器不会收到重复的组播数据报)。不同的组播组对应于不同的组播转发树；同一个组播组，对不同的源点也会有不同的组播转发树。(实际上，IP广播也采用类似的算法，构造最小生成树来进行广播，从而避免广播风暴以及冗余广播分组的传输)

## 5.5 网络管理和SNMP

### 5.5.1 网络管理框架

- 管理服务器：一个应用程序，运行在网络运营中心的集中式网络管理工作站上
- 被管设备：位于被管理的网络中
- 管理信息库：存储一个被管设备中的每个被管对象的关联信息
- 网络管理代理：运行在被管设备中的一个进程，用于与管理服务器通信
- 网络管理协议：运行在管理服务器和被管设备之间，允许管理服务器查询被管设备的状态，并经过其代理间接地在这些设备上采取行动。

### 5.5.2 简单网络管理协议

简单网络管理协议(SNMP, Simple Network Management Protocol)是一个应用层协议，用于在管理服务器和代表管理服务器执行的代理之间传递网络管理控制和信息报文。SNMP最常使用的是请求响应模式，其中SNMP管理服务器向SNMP代理发送一个请求，代理接收到该请求后，执行某些动作，然后对该请求发送一个回答。SNMP第二个常被使用的是代理向管理服务器发送的一种非请求报文，该报文称为陷阱报文，用于通知管理服务器一个异常情况已经导致了MIB对象值的改变。

## 5.6 移动IP

### 5.6.1 移动IP的概念

支持移动性的因特网体系结构与协议共称为移动IP，它是为了满足移动结点在移动中保持其连接性而设计的。更确切地说，移动IP技术是指移动结点以固定的网络IP地址实现跨越不同网段的漫游功能，并保证基于网络IP的网络权限在漫游过程中不发生任何改变。基于IPv4的移动IP定义三种功能实体：移动结点、归属代理(本地代理)、外部代理。
- 移动结点：具有永久IP地址的移动结点
- 本地代理：在一个网络环境中，一个移动结点的永久居所被称为归属网络，在归属网络中代表移动结点执行移动管理功能的实体称为归属代理，它根据移动用户的转交地址，采用隧道技术转交移动结点的数据包
- 外部代理：移动结点当前所在网络叫作外部网络，在外部网络中帮助移动结点完成移动管理功能的实体称为外部代理

注意移动IP与动态IP不同，动态IP指的是局域网中的计算机可以通过网络中的DHCP服务器动态地获得一个IP地址，不需要用户在计算机的网络设置中指定IP地址。

### 5.6.2 移动IP通信过程

在移动IP中，每个移动结点都有一个唯一的==本地地址(永久地址)==，当移动结点移动时，它的本地地址是不变的，在外部网络链路上每个移动结点还必须有一个外部代理来为它维护当前的位置信息，这就需要引入转交地址。当移动结点连接到外部网络链路上时，==转交地址==就用来标识移动结点现在所处的位置，以便进行路由选择。移动结点的本地地址与当前转交地址的联合称为移动绑定，简称绑定。当移动结点得到一个新的转交地址时，通过绑定向本地代理进行注册，以便让本地代理即时了解移动结点的当前位置。移动IP技术的基本通信流程如下：
1. 移动结点在本地网时，按传统的TCP/IP方式进行通信
2. 移动结点漫游到一个外地网络时，仍然使用固定的IP地址进行通信。为了能够收到通信对端发给它的IP分组，移动结点需要向本地代理注册当前的位置地址，这个地址就是转交地址
3. 本地代理接收来自转交地址的注册后，会构建一条通向转交地址的隧道，将截获的发给移动结点的IP分组通过隧道送到转交地址处
4. 在转交地址处解除隧道封装，恢复原始IP分组，最后送到移动结点，这样移动结点在外网就能够收到这些发送给它的IP分组
5. 移动结点在外网通过外网的路由器或外部代理直接向通信对端==发送IP数据包==(使用自己的永久地址作为源地址，通信对端的地址作为目的地址)，而==无需再通过本地代理迂回发送数据==
6. 移动结点来到另一个外网时，只需向本地代理更新注册的转交地址，就可继续通信
7. 移动结点回到本地网时，移动结点向本地代理注销转交地址，这时移动结点又将使用传统的TCP/IP方式进行通信

注意移动IP为移动主机设置了两个IP地址，即主地址和辅地址(转交地址)。移动主机在本地网时，使用的是主地址；当移动到另一个网络时，需要获得一个临时的辅地址，但此时主地址仍然不变；从外网移回本地网时，辅地址撤销，而主地址仍然保持不变。


# 第6章 链路层

## 6.1 链路层概述

链路层的基本服务是将数据报通过单一通信链路从一个节点移动到相邻节点。链路层协议提供的可能服务有：
- 成帧：网络层数据报经链路传送前，链路层协议要将其用链路层帧封装起来
- 链路接入：媒体访问控制(MAC，Medium Access Control)协议规定了帧在链路上传输的规则。
- 可靠交付：可靠交付通常用于易于产生高差错率的无线链路，许多有线链路不提供可靠交付
- 差错检测和纠正：通过奇偶校验、检验和方法(更多用于运输层)、循环冗余检测(更多用于链路层)等方法进行差错检测和纠正

在路由器中，链路层是在线路卡中实现的；在主机中，链路层的主体部分是在网络适配器中实现的，网络适配器有时也称为网络接口卡(网卡)，位于网络适配器核心的是链路层控制器，该控制器通常是一个实现了许多链路层服务的专用芯片。因此，链路层控制器的许多功能是用硬件实现的，但部分链路层是在运行于主机CPU上的软件实现的，所以链路层是协议栈中软件与硬件交接的地方。

## 6.2 多路访问链路和协议

有两种类型的网络链路：==点对点链路==和==广播链路==。点对点链路由链路一端的单个发送方和链路另一端的单个接收方组成，许多链路层协议都是为点对点链路设计的，如PPP和HDLC。广播链路能够让多个发送和接收节点都连接到相同的、单一的、共享的广播信道，当任何一个节点传输一个帧时，信道广播该帧，每个其他节点都收到一个副本，以太网和无线局域网就是广播链路层技术的例子。如何协调多个发送和接收节点对一个共享广播信道的访问，这就是多路访问问题，节点通过==多路访问协议==来规范它们在共享的广播信道上的传输行为。

### 6.2.1 信道划分协议

频分多路复用(FDM)：FDM将传输速率R bps的信道划分为不同的频段(每个频段具有R/N带宽)，并把每个频率分配给N个节点中的一个。它避免了碰撞，在N个节点之间公平地划分了带宽；但缺点是即使只有一个要发送分组的节点时，它也只能使用R/N的带宽。光的频分多路复用又称波分多路复用。

时分多路复用(TDM)：TDM将时间划分为时间帧，并进一步划分每个时间帧为N个时隙，然后把每个时隙分配给N个节点中的一个。它同样避免碰撞；但缺点仍与FDM相同。

码分多址(CDMA)：CDMA对每个节点分配一种不同的编码，每个节点用它唯一的编码来对它发送的数据进行编码，从而不同节点能够同时传输，并且它们各自相应的接收方仍能正确接收发送方编码的数据比特。例如A站的码片序列为00011011，则A站发送00011011就表示发送比特1，发送11100100就表示发送比特0，A站对应的码片向量为(-1,-1,-1,1,1,-1,1,1)，而B站设置的码片向量需要与A正交，于是在终点可以对A和B发来的数据进行分离，只需要将发来的数据分别与A的B的码片向量作内积即可。CDMA在无线LAN和蜂窝技术中应用广泛。

### 6.2.2 随机接入协议

在随机接入协议中，一个传输节点总是以信道的全部速率(R bps)进行发送，然后采取不同策略来处理发生碰撞的情况。

#### ALOHA协议

纯ALOHA协议：节点要传输新分组时立即发送，一旦碰撞就立刻以概率p重传该帧，若没有重传，则等待一个帧传输时间后再以p概率重传，以此类推。

时隙ALOHA协议：节点要传输新分组时等到下一个时隙开始时传输，一旦碰撞则在后续的每个时隙中以概率p重传该帧，直到该帧被无碰撞地传输出去。

#### 载波侦听多路访问(CSMA)协议

1-坚持CSMA：一个节点要发送数据时，首先侦听信道；如果信道空闲则立即发送数据；如果信道忙则继续侦听直到信道空闲。如果发生碰撞，那么随机等待一段时间后，再重新开始侦听信道后发送数据。

非坚持CSMA：一个节点要发送数据时，首先侦听信道；如果信道空闲则立即发送数据；如果信道忙则放弃侦听，等待一个随机的时间后再重复上述过程。

p-坚持CSMA：一个节点要发送数据时，首先侦听信道；如果信道忙则继续侦听直到信道空闲；如果信道空闲，那么以概率p发送数据，以概率1-p推迟到下一个时隙；如果在下一个时隙信道仍然空闲，则仍以概率p发送数据，以概率1-p推迟到下一个时隙，如果信道忙则等待下一个时隙再重新开始侦听。

#### 载波侦听多路访问/碰撞检测(CSMA/CD)协议

一个节点要发送数据时，首先侦听信道，如果信道空闲则立即发送数据，如果信道忙则继续侦听直到信道空闲。在传输过程中，节点持续检测信道，一旦检测到碰撞，则立即中止传输，然后等待一个随机时间量后继续侦听重传。其中等待随机时间采用了二进制指数后退算法，即如果该帧已经经历了n次碰撞，则随机从{0,1,2,…,$2^n-1$}中选择一个K值，然后等待$K\times 512$比特时间(即发送512比特进入以太网所需时间量的K倍)，注意若n＞10则就取n=10，当重传16次仍不能成功时，就丢弃此帧并报错。

#### 载波侦听多路访问/碰撞避免(CSMA/CA)协议

一个节点要发送新数据时，首先侦听信道，如果信道空闲，则等待一段很短的时间(继续侦听)后发送整个数据帧。否则，选取一个随机的时间设为退避计时器的值，接下来一旦检测到信道忙，退避计时器就保持不变；只要信道空闲，退避计时器就进行倒计时。当退避计时器减到0时，就发送整个帧并等待确认。如果没收到确认(发生碰撞)，则在更大范围内重新选取一个随机的时间，重复上述操作；如果收到确认，要开始传送下一帧，同样从重新选取一个随机的时间的步骤开始，重复上述操作。除此之外，CSMA/CA还包括了一个可选的预约方案，以帮助在出现隐藏终端的情况下避免碰撞：如果两个相距较远的无线站点都在某AP覆盖范围内，但由于衰减，这两个无线站点彼此隐藏，因此它们无法侦听到彼此的传输，可能导致碰撞，于是CSMA/CA允许站点使用一个短==请求发送==(RTS, Request to Send)控制帧和一个短==允许发送==(CTS, Clear to Send)控制帧来预约对信道的访问，当发送方要发送一个DATA帧时，首先向AP发送一个RTS帧，指示传输DATA帧和确认帧需要的总时间；当AP收到RTS帧后，它广播一个CTS帧作为响应，既给发送方明确的发送许可，也指示其他站点在预约期内不要发送，从而缓解了隐藏终端问题。CSMA/CD用于有线局域网，而CSMA/CA用于无线局域网。

### 6.2.3 轮流协议

轮询协议：一个主节点以循环的方式轮询每个节点，例如主节点先向节点1发送一个报文，告诉它能够传输的帧的最多数量，在节点1传输了某些帧后，主节点再告诉节点2能够传输的帧的最多数量。

令牌传递协议：一个称为令牌的小的特殊帧在节点之间沿着环型总线依次传递，当一个节点收到令牌时，如果它没有帧要发送，就立即向下一个节点转发该令牌，如果它要发送帧，则发送最大数目的帧数后再把令牌转发给下一个节点。

## 6.3 ARP

### 6.3.1 MAC地址

网卡是一块被设计用来允许计算机在计算机网络上进行通讯的计算机硬件，又称为网络适配器或网络接口卡NIC。主机或路由器的每个网卡具有唯一固定的链路层地址(硬件地址、物理地址、MAC地址)，用来确认网络设备的位置，MAC地址由网络设备制造商生产时烧录在网卡中。链路层交换机没有链路层地址，它透明地执行在主机与路由器之间承载数据报的任务。对大多数局域网而言，MAC地址长度6字节，通常用十六进制表示法，如5C-66-AB-90-75-B1。一般MAC地址是固定的（也有软件改变适配器MAC地址的可能），没有两块适配器有相同的MAC地址。MAC地址空间由IEEE管理，IEEE给公司固定前24个比特(代表网络硬件制造商的编号)，后面24个比特让公司自己去生成。

当某适配器要向目的适配器发送一个帧时，发送适配器将目的适配器的MAC地址插入该帧，发送到局域网上，当适配器接受一个帧时，检查帧中的目的MAC地址与自己的MAC地址是否匹配，若匹配则取出数据报，向上传递，否则丢弃。如果发送适配器想让局域网上所有其他适配器来接收并处理它打算发送的帧，则通过特殊的MAC广播地址FF-FF-FF-FF-FF-FF来广播。

### 6.3.2 ARP

地址解析协议(ARP, Address Resolution Protocol)的作用是通过IP地址查找MAC地址。逆地址解析协议(RARP, Reverse Address Resolution Protocol)的作用是通过MAC地址查找IP地址。

![](/zzimages/20230522145256.png)

假设IP地址为111.111.111.111的主机要向主机111.111.111.112发送IP数据报，则源主机必须要向它的适配器不仅提供IP数据报，还要提供目的主机的MAC地址，所以需要使用ARP。在发送主机中的ARP模块将取在相同局域网上的任何IP地址为输入，然后返回相应的MAC地址，具体而言，每台主机或路由器在其内存中具有一个ARP表，这张表包含IP地址到MAC地址的映射关系，以及寿命TTL(指示了从表中删除每个映射的时间)，注意这张表不必为该子网上的每台主机和路由器都包含一个表项。那么如果发送主机中的ARP表没有111.111.111.112的表项，发送方就会用ARP协议来解析这个地址：首先，发送方向它的适配器传递一个ARP查询分组(ARP分组分为ARP查询分组和ARP响应分组，它们格式相同，都包含发送和接收IP地址及MAC地址)，并且指示适配器应该用MAC广播地址来发送这个分组；于是该子网的所有其他适配器都收到这个分组，它们检查自己的IP地址是否与该ARP分组中的目的IP地址相匹配，与之匹配的话就向查询主机发送回一个带有所希望映射的ARP响应分组；然后查询主机更新它的ARP表，接下来就可正常发送数据。注意到==ARP查询分组是在广播帧中发送的==，而==ARP响应分组是在一个标准帧中发送的==，并且ARP是即插即用的，即一个ARP表是自动建立的，无需系统管理员来配置。注意到ARP和DNS很类似，但==ARP将一个IP地址解析为一个MAC地址，且只为在同一个子网上的主机和路由器接口解析IP地址，而DNS将主机名解析为IP地址，且为因特网中任何地方的主机解析主机名==。一般将ARP认为是跨越链路层和网络层边界两边的协议。

如果主机111.111.111.111要向子网以外的主机222.222.222.222发送IP数据报，那么该数据报会首先经过路由器接口111.111.111.110，因此适当的目的MAC地址并不是222.222.222.222的MAC地址，而是111.111.111.110的MAC地址E6-E9-00-17-BB-4B，主机通过ARP即可获得该MAC地址。于是该IP数据报可以从源主机移动到这台路由器，然后根据目的IP地址查询路由器中的转发表，判断出接下来将通过接口222.222.222.220来转发，这时在右边的子网中同样通过ARP来获取目的MAC地址49-BD-D2-C7-56-2A，然后进行传送(此时的源MAC地址也改为1A-23-F9-CD-06-9B)。

#### ARP请求/应答报文结构

![](/zzimages/20230522211612.png)

- 硬件类型：1表示MAC地址
- 协议类型：0x800表示IP地址
- 硬件地址长度：6
- 协议地址长度：4
- 操作：1表示ARP请求，2表示ARP应答，3表示RARP请求，4表示RARP应答

注意ARP报文还需要封装上以太网帧首部和尾部，组成帧后才能进行传输，此时以太网帧首部中的类型字段应为0x806，表示ARP。


## 6.4 局域网

局域网(Local Area Network, LAN)是指在一个较小的地理范围内将各种计算机、外部设备、数据库系统等通过双绞线、同轴电缆等连接介质互相连接起来，组成资源和信息共享的计算机互联网络。以太网是目前最流行的有线局域网，早期以太网是基于集线器的星形拓扑(逻辑上是总线形拓扑)，如今位于中心的集线器被交换机所替代。

### 6.4.1 以太网IEEE802.3

#### 以太网帧结构

![](/zzimages/20230522145920.png)

- 数据字段(46~1500字节)：这个字段承载了IP数据报，以太网的最大传输单元(MTU)是1500字节，数据字段最小是46字节，如果不够则需要填充，此时传递到网络层的数据包括IP数据报和填充部分，网络层使用IP数据报首部中的长度字段来去除填充部分。
- 目的地址(6字节)：目的适配器的MAC地址
- 源地址(6字节)：传输该帧到局域网上的适配器的MAC地址
- 类型字段(2字节)：指明网络层协议。0x800表示IP、0x806表示ARP、0x835表示RARP。
- CRC(4字节)：用于差错检验
- 前同步码(8字节，一般不计入帧首部)：前7字节值都是10101010，最后一个字节值是10101011，用于唤醒接收适配器，并且将它们的时钟和发送方的时钟同步。

#### 以太网技术

以太网技术向网络层提供无连接、不可靠的服务，当某帧没有通过CRC校验时，接收适配器只是丢弃该帧，所以发送适配器并不知道它传输的帧是否到达并通过了CRC校验。今天的以太网，结点经点对点由双绞铜线或光纤线缆构成的线段与一台交换机相连，现代交换机是全双工的，一台交换机和一个结点能同时向对方发送帧而没有干扰。吉比特以太网是一种高速以太网，它使用标准以太网帧格式，允许点对点链路(使用交换机)以及共享的广播信道(使用集线器)，使用==CSMA/CD==来共享广播信道，对于点对点信道允许在两个方向上都以40Gbps全双工操作。

### 6.4.2 无线局域网IEEE802.11

基站是无线网络基础设施的一个关键部分，负责协调与之相关联的多个无线主机的传输(一台主机与基站相关联指的是该主机位于该基站的无线通信覆盖范围内，且该主机使用该基站中继它和更大网络之间的数据)，蜂窝网络中的蜂窝塔和802.11无线LAN中的接入点都是基站的例子。与基站关联的主机通常被称为以基础设施模式运行；如果无线主机没有这样的基础设施与之相连，则称为自组织网络。采用IEEE802.11标准的无线局域网以基础设施模式运行，它又称为WiFi，要求链路层实现可靠传输，它是星形拓扑，其中心称为接入点(AP, Access Point)，使用==CSMA/CA==协议。

802.11体系结构的基本构件模块是基本服务集(BSS, Basic Service Set)，一个BSS包含一个或多个无线站点和一个称为接入点的中央基站(每个AP的无线接口都有一个MAC地址)。在一个典型的家庭网络中，有一个AP和一台将该BSS连接到因特网中的路由器。802.11无线LAN被称作基础设施无线LAN，其中的基础设施是指AP连同互联AP和一台路由器的有线以太网。

![](/zzimages/20230522150228.png)

- 地址2是传输该帧的站点的MAC地址
- 地址1是要接收该帧的无线站点的MAC地址
- 地址3是一个路由器接口的MAC地址，该子网通过这个路由器接口与其他子网相连

![](/zzimages/20230522150301.png)

### 6.4.3 虚拟局域网

一个以太网是一个广播域，所以如果以太网中包含的计算机太多往往会导致出现大量的广播帧。通过虚拟局域网(VLAN)可以把一个较大的局域网分割成一些较小的与地理位置无关的逻辑上的VLAN，而每个VLAN是一个较小的广播域。虚拟局域网只是一种服务，而不是一种新型局域网。

![](/zzimages/20230522150352.png)

以太网帧要增加一个4字节的VLAN标签，扩展的帧称为802.1Q帧。VID唯一标识了该帧属于哪个VLAN，如VLAN-10中的10就是VID。

![](/zzimages/20230522150409.png)

各主机并不知道自己的VID值，但交换机必须知道，主机与交换机之间交互的都是标准以太网帧。一个VLAN的范围可以跨越不同的交换机，如上图所示，这两个VLAN虽然都跨越了两个交换机，但各自都是一个广播域。假定A向B发送帧，交换机1根据帧首部的目的MAC地址，识别B属于本交换机管理的VLAN-10，于是就像在普通以太网中那样直接转发帧。假定A向E发送帧，则交换机1必须把帧转发到交换机2，在转发前要插入VLAN标签，所以在交换机端口之间的链路上传送的是802.1Q帧，而交换机2发送给E的又是标准以太网帧。如果A向C发送数据，则需要通过上层的路由器，因为已经不是在一个VLAN中了。

## 6.5 广域网


广域网通常是指覆盖范围很广的长距离网络。局域网可以通过广域网与另一个相隔很远的局域网通信。广域网由一些结点交换机及连接这些交换机的链路组成。广域网使用的协议主要在网络层，而局域网使用的协议主要在链路层。常见的广域网链路层协议是PPP协议和HDLC协议(HDLC已很少使用)。

PPP(Point-to-Point Protocol)是使用串行线路通信的面向字节的协议，该协议应用在直接连接两个结点的链路上。设计的目的主要是用来通过拨号或专线方式建立点对点连接发送数据，使其成为各种主机、网桥和路由器之间简单连接的一种共同的解决方案。PPP有三个组成部分：
- 链路控制协议LCP：用于建立、配置、测试和管理数据链路；
- 网路控制协议NCP：PPP协议允许同时采用多种网络层协议，每个不同的网络层协议要用一个相应的NCP来配置，为网络层协议建立和配置逻辑连接；
- 一个将IP数据报封装到串行链路的方法

![](/zzimages/20230522150640.png)

注意PPP只支持点对点的链路通信，且提供不可靠的服务。PPP两端可以运行不同的网络层协议，但仍然可使用同一个PPP进行通信。

## 6.6 链路层交换机

### 6.6.1 交换机转发和过滤

过滤是决定一个帧应该转发到某个接口还是应当将其丢弃的交换机功能；转发是决定一个帧应该被导向哪个接口，并把该帧移动到那些接口的交换机功能。交换机的过滤和转发借助于交换机表完成，该交换机表包含某局域网上某些主机和路由器的但不必是全部的表项。交换机表中的一个表项包含：一个MAC地址、通向该MAC地址的交换机接口、表项放置在表中的时间。当交换机的x接口收到一个目的MAC地址时，交换机用该地址索引交换机表，有3种可能情况：
- 表中没有该MAC地址的表项。此时交换机向除接口x外的所有接口前面的输出缓存转发该帧的副本。
- 表中有该MAC地址的表项，且对应表项接口就是x。此时直接丢弃该帧执行过滤功能即可。
- 表中有该MAC地址的表项，且对应表项接口$y\neq x$。此时交换机通过将该帧放到接口y前面的输出缓存完成转发功能。

### 6.6.2 自学习

交换机是自学习的，它的表是自动建立的，没有来自网络管理员或来自配置协议的任何干预。具体实现如下：
1. 交换机表初始为空
2. 对于在每个接口接收到的每个入帧，该交换机在其表中存储：该帧源地址字段中的MAC地址、该帧到达的接口、当前时间。交换机以这种方式在它的表中记录了发送节点所在的局域网网段。
3. 如果在一段时间后(老化期后)，交换机没有接收到以该地址作为源地址的帧，就在表中删除这个地址。

交换机是即插即用设备，因为它们不需要网络管理员的干预。交换机也是双工的，这意味任何交换机接口能够同时发送和接收。除此之外，交换机还有一些别的优点：
- 不会发生碰撞，任何时候交换机决不会向相同的接口转发超过一个帧。
- 交换机将链路彼此隔离，所以局域网中的不同链路能够在不同的媒体上运行。
- 除了提供强化的安全性，交换机也易于进行网络管理。

注意交换机中的地址转发表和路由器中的路由控制表都不需要在网络中的各个节点上手动设置，而是由这些节点自动生成的，地址转发表根据自学习自动生成，路由控制表则根据路由选择协议自动生成。


# 第7章 物理层

## 7.1 物理层基本概念

### 7.1.1 物理层接口特性

![](/zzimages/20230522151109.png)

### 7.1.2 数据通信基础知识

#### 数据通信模型

![](/zzimages/20230522151137.png)

#### 数据通信相关术语

![](/zzimages/20230522151151.png)

#### 通信方式

- 单工通信：只有一个方向的通信而没有反方向的交互，仅需要一条信道，如广播
- 半双工通信：通信的双方都可以发送或接收消息，但任何一方都不能同时发送和接收信息，此时需要两条信道
- 全双工通信：通信双方可以同时发送和接收信息，也需要两条信道

#### 传输方式

- 串行传输：将每个bit按顺序依次发送。速度慢，费用低，适合远距离传输。
- 并行传输：将多个bit通过多条信道同时发送。速度快，费用高，适合近距离传输。

#### 实现同步的传输/通信方式

![](/zzimages/20230522151301.png)

#### 速率与带宽

速率：即数据的传输速率，可以用码元传输速率和信息传输速率来表示。码元传输速率又称波特率，表示单位时间内数字通信系统所传输的码元个数，单位是波特(Baud)，注意码元速率和码元进制数无关，只与码元宽度有关；信息传输速率又称比特率，表示单位时间内数字通信系统所传输的比特数，单位是b/s。可见，若一个码元携带n比特的信息量，则M波特的码元传输速率所对应的信息传输速率为Mn b/s。一般来说系统传输速率依据信息传输速率。

注：码元是指用一个固定时长的信号波形(数字脉冲)，代表不同离散数值的基本波形，是数字通信中数字信号的计量单位，这个时长称为码元宽度，这个时长内的信号称为k进制码元(码元有k个离散状态，就称为k进制码元)。1码元可以携带多个比特的信息量，比如一个16进制码元可以携带4bit的信息量(因为需要4bit才能表示出16种不同离散状态)。

带宽：模拟信号系统中，最高频率和最低频率间的差值就是系统的通频带宽，单位是Hz；数字信号系统中，带宽表示单位时间内从网络中的某一点到另一点所能通过的最高数据率，用来表示网络的通信线路所能传输数据的能力，单位是b/s

### 7.1.3 奈氏定理和香农定理

![](/zzimages/20230522151408.png)

![](/zzimages/20230522151414.png)

![](/zzimages/20230522151422.png)

![](/zzimages/20230522151437.png)

## 7.2 编码与调制

![](/zzimages/20230522151459.png)

![](/zzimages/20230522151515.png)

### 数字数据编码为数字信号

![](/zzimages/20230522151549.png)
![](/zzimages/20230522151555.png)
![](/zzimages/20230522151601.png)

![](/zzimages/20230522151609.png)
![](/zzimages/20230522151619.png)
![](/zzimages/20230522151626.png)
![](/zzimages/20230522151631.png)
![](/zzimages/20230522151639.png)

### 数字数据调制为模拟信号

![](/zzimages/20230522151659.png)

### 模拟数据编码为数字信号

![](/zzimages/20230522151719.png)

### 模拟数据调制为模拟信号

![](/zzimages/20230522151740.png)

## 7.3 数据交换方式

### 7.3.1 电路交换

![](/zzimages/20230522151823.png)

![](/zzimages/20230522151830.png)

### 7.3.2 报文交换

![](/zzimages/20230522151848.png)

![](/zzimages/20230522151855.png)

### 7.3.3 分组交换

![](/zzimages/20230522151915.png)

![](/zzimages/20230522151926.png)

#### 数据报方式

![](/zzimages/20230522151942.png)

![](/zzimages/20230522151950.png)

#### 虚电路方式

![](/zzimages/20230522152008.png)

![](/zzimages/20230522152017.png)

![](/zzimages/20230522152106.png)

![](/zzimages/20230522152122.png)

## 7.4 传输介质

![](/zzimages/20230522152152.png)

![](/zzimages/20230522152202.png)

![](/zzimages/20230522152209.png)

![](/zzimages/20230522152215.png)

![](/zzimages/20230522152223.png)

![](/zzimages/20230522152230.png)

![](/zzimages/20230522152238.png)

## 7.5 物理层设备

![](/zzimages/20230522152338.png)

![](/zzimages/20230522152349.png)

